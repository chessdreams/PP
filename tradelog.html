<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeLog - PortfolioPro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    maxWidth: {
                        '8xl': '88rem',
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        'primary': {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                        'success': '#10B981',
                        'danger': '#EF4444',
                        'warning': '#F59E0B',
                        'info': '#3B82F6',
                        'gray': {
                            50: '#f9fafb',
                            100: '#f3f4f6',
                            200: '#e5e7eb',
                            300: '#d1d5db',
                            400: '#9ca3af',
                            500: '#6b7280',
                            600: '#4b5563',
                            700: '#374151',
                            800: '#1f2937',
                            900: '#111827',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Professional Navigation Styles */
        .nav-btn {
            @apply px-4 py-2 rounded-lg text-white/80 hover:text-white hover:bg-white/10 transition-all duration-200 font-medium text-sm border border-transparent;
        }
        
        .nav-btn.active {
            @apply bg-white/20 text-white shadow-lg;
        }
        
        .nav-btn:hover {
            @apply text-white bg-white/10;
        }
        
        .mobile-nav-btn {
            @apply w-full text-left px-4 py-3 rounded-lg text-white/80 hover:text-white hover:bg-white/10 transition-all duration-200 font-medium border border-transparent;
        }
        
        .mobile-nav-btn.active {
            @apply bg-white/20 text-white;
        }
        
        .mobile-nav-btn:hover {
            @apply text-white bg-white/10;
        }

        /* Professional Card Styles */
        .professional-card {
            @apply bg-white rounded-lg shadow-md border border-gray-200 hover:shadow-lg transition-all duration-300 hover-lift;
        }
        
        .metric-card {
            @apply professional-card p-6 text-center;
        }
        
        .metric-value {
            @apply text-3xl font-bold text-gray-900 mb-2;
        }
        
        .metric-label {
            @apply text-sm font-medium text-gray-500 uppercase tracking-wider;
        }
        
        .metric-change {
            @apply text-sm font-medium;
        }
        
        .metric-change.positive {
            @apply text-green-600;
        }
        
        .metric-change.negative {
            @apply text-red-600;
        }

        /* Loading States */
        .loading-spinner {
            @apply animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600;
        }
        
        .skeleton {
            @apply animate-pulse bg-gray-200 rounded;
        }

        /* Professional Animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        .scale-in {
            animation: scaleIn 0.2s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes scaleIn {
            from { 
                opacity: 0;
                transform: scale(0.95);
            }
            to { 
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Hover Effects */
        .hover-lift {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        
        .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* Professional Transitions */
        .transition-smooth {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Professional Button Styles */
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 shadow-lg hover:shadow-xl;
        }
        
        .btn-secondary {
            @apply bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200;
        }
        
        .btn-success {
            @apply bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200;
        }
        
        .btn-danger {
            @apply bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200;
        }
        
        .btn-warning {
            @apply bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200;
        }
        
        .btn-info {
            @apply bg-cyan-600 hover:bg-cyan-700 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200;
        }

        /* Table Styles */
        .table-container {
            @apply overflow-x-auto rounded-lg border border-gray-200;
        }
        
        .table-header {
            @apply bg-gray-50 px-3 py-2 text-left text-xs font-medium text-gray-700 border-b;
        }
        
        .table-cell {
            @apply px-3 py-2 text-sm text-gray-900;
        }
        
        .table-cell-right {
            @apply px-3 py-2 text-sm text-gray-900 text-right;
        }
        
        .table-cell-center {
            @apply px-3 py-2 text-sm text-center;
        }
        
        /* Trade Type Badges */
        .trade-badge {
            @apply px-2 py-1 text-xs font-medium rounded-full;
        }
        
        .trade-badge.buy {
            @apply bg-green-100 text-green-800;
        }
        
        .trade-badge.sell {
            @apply bg-red-100 text-red-800;
        }
        
        /* P&L Color Coding */
        .pnl-positive {
            @apply text-green-600;
        }
        
        .pnl-negative {
            @apply text-red-600;
        }
        
        .pnl-neutral {
            @apply text-gray-500;
        }
        
        /* Notification Styles */
        .notification {
            @apply fixed top-4 right-4 p-4 rounded-lg text-white z-50;
        }
        
        .notification.success {
            @apply bg-green-500;
        }
        
        .notification.error {
            @apply bg-red-500;
        }
        
        .notification.warning {
            @apply bg-yellow-500;
        }
        
        .notification.info {
            @apply bg-blue-500;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b sticky top-0 z-50">
        <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <!-- Logo and Brand -->
                <div class="flex items-center space-x-3 cursor-pointer" onclick="window.location.href='index.html'">
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-line text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">PortfolioPro</h1>
                        <p class="text-sm text-gray-600">Professional Portfolio Management</p>
                    </div>
                </div>

                <!-- Navigation Menu -->
                <nav class="hidden md:flex space-x-2">
                    <button onclick="window.location.href='index.html'" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors shadow-lg flex items-center">
                        <i class="fas fa-chart-pie mr-2"></i>Portfolio
                    </button>
                    <button onclick="window.location.href='calculator.html'" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fas fa-calculator mr-2"></i>Calculator
                    </button>
                    <button onclick="window.location.href='targets.html'" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fas fa-bullseye mr-2"></i>Targets
                    </button>
                    <button onclick="window.location.href='transactions.html'" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fas fa-exchange-alt mr-2"></i>Transactions
                    </button>
                    <button onclick="window.location.href='tradelog.html'" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fas fa-chart-bar mr-2"></i>TradeLog
                    </button>
                    <button onclick="window.location.href='settings.html'" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </button>
                </nav>

                <!-- Mobile Menu Button -->
                <button id="mobileMenuBtn" class="md:hidden text-gray-600 p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>

            <!-- Mobile Navigation -->
            <div id="mobileMenu" class="md:hidden hidden pb-4">
                <div class="flex flex-col space-y-2">
                    <button onclick="window.location.href='index.html'" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors shadow-lg flex items-center">
                        <i class="fas fa-chart-pie mr-2"></i>Portfolio
                    </button>
                    <button onclick="window.location.href='calculator.html'" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fas fa-calculator mr-2"></i>Calculator
                    </button>
                    <button onclick="window.location.href='targets.html'" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fas fa-bullseye mr-2"></i>Targets
                    </button>
                    <button onclick="window.location.href='transactions.html'" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fas fa-exchange-alt mr-2"></i>Transactions
                    </button>
                    <button onclick="window.location.href='tradelog.html'" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fas fa-chart-bar mr-2"></i>TradeLog
                    </button>
                    <button onclick="window.location.href='settings.html'" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Container -->
    <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">TradeLog Analysis</h1>
            <p class="text-gray-600 mt-2">Upload your trading data and analyze your performance with detailed insights</p>
        </div>

        <!-- Upload Section -->
        <div class="professional-card rounded-2xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Upload Trading Data</h2>
            
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Excel File</label>
                <div class="flex items-center space-x-4">
                    <input type="file" id="excelFile" accept=".xlsx,.xls" class="hidden">
                    <button id="selectFileBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                        Choose Excel File
                    </button>
                    <span id="fileName" class="text-sm text-gray-600">No file selected</span>
                </div>
                <p class="text-xs text-gray-500 mt-1">Supported formats: Excel files (.xlsx, .xls) with trading data</p>
            </div>

            <div class="flex space-x-4">
                <button id="uploadBtn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    📊 Analyze Trades
                </button>
                <button id="clearBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-6 rounded-lg transition-colors">
                    Clear Data
                </button>
            </div>
        </div>

        <!-- Trade Analysis Section -->
        <div id="tradeAnalysisSection" class="hidden professional-card rounded-2xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Trading Analysis Results</h2>
            
            <!-- Trading Journal Table -->
            <div id="tradingJournalContainer" class="hidden mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Daily Trading Journal</h3>
                    <div class="flex items-center space-x-3">
                        <button id="exportTradingJournalBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            📊 Export
                        </button>
                        <button id="printTradingJournalBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            🖨️ Print
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table id="tradingJournalTable" class="w-full border-separate border-spacing-0" style="min-width: 1400px;">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-700 border-b">Date</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-700 border-b">Stock</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-700 border-b">Amount</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-700 border-b">Ave Price</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-700 border-b">Market Value</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-700 border-b">Type</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-700 border-b">Sold Date</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-700 border-b">Duration</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-700 border-b">Sold Price</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-700 border-b">Sell Order Value</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-700 border-b">P&L</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-700 border-b">P&L%</th>
                                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-700 border-b">Annualized Return</th>
                            </tr>
                        </thead>
                        <tbody id="tradingJournalTableBody">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Portfolio Holdings Summary -->
            <div id="portfolioHoldingsSummary" class="hidden mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Current Holdings Summary</h3>
                    <div class="flex items-center space-x-3">
                        <button id="exportHoldingsSummaryBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            📊 Export
                        </button>
                        <button id="printHoldingsSummaryBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            🖨️ Print
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table id="holdingsSummaryTable" class="w-full border-separate border-spacing-0" style="min-width: 1000px;">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 border-b">Symbol</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-700 border-b">Total Qty</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-700 border-b">Avg Cost</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-700 border-b">Current Price</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-700 border-b">Market Value</th>
                                <th class="px-4 py-3 text-right text-sm font-medium text-gray-700 border-b">Unrealized P&L</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsSummaryTableBody">
                            <!-- Dynamic content will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Trading Performance Summary -->
            <div id="tradingPerformanceSummary" class="hidden">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Trading Performance Summary</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-green-800">Total Profit</h4>
                        <p id="totalProfit" class="text-2xl font-bold text-green-600">Rs. 0.00</p>
                    </div>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-red-800">Total Loss</h4>
                        <p id="totalLoss" class="text-2xl font-bold text-red-600">Rs. 0.00</p>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-blue-800">Net P&L</h4>
                        <p id="netPnL" class="text-2xl font-bold text-blue-600">Rs. 0.00</p>
                    </div>
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-purple-800">Win Rate</h4>
                        <p id="winRate" class="text-2xl font-bold text-purple-600">0%</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-gray-800">Total Trades</h4>
                        <p id="totalTrades" class="text-2xl font-bold text-gray-600">0</p>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-yellow-800">Avg Profit per Trade</h4>
                        <p id="avgProfitPerTrade" class="text-2xl font-bold text-yellow-600">Rs. 0.00</p>
                    </div>
                    <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-indigo-800">Best Trade</h4>
                        <p id="bestTrade" class="text-2xl font-bold text-indigo-600">Rs. 0.00</p>
                    </div>
                    <div class="bg-pink-50 border border-pink-200 rounded-lg p-4">
                        <h4 class="text-sm font-medium text-pink-800">Worst Trade</h4>
                        <p id="worstTrade" class="text-2xl font-bold text-pink-600">Rs. 0.00</p>
                    </div>
                </div>
            </div>

            <div class="flex space-x-4">
                <button id="analyzeTradesBtn" class="bg-orange-600 hover:bg-orange-700 text-white font-medium py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    🔍 Analyze Trades
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let uploadedData = [];
        let allTrades = [];
        let processedStocks = new Set();

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });

        function setupEventListeners() {
            // Mobile menu toggle
            document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                const mobileMenu = document.getElementById('mobileMenu');
                mobileMenu.classList.toggle('hidden');
            });

            // File selection
            document.getElementById('selectFileBtn').addEventListener('click', () => {
                document.getElementById('excelFile').click();
            });

            document.getElementById('excelFile').addEventListener('change', handleFileSelect);
            document.getElementById('uploadBtn').addEventListener('click', processFile);
            document.getElementById('clearBtn').addEventListener('click', clearData);
            document.getElementById('analyzeTradesBtn').addEventListener('click', analyzeTrades);

            // Export buttons
            document.getElementById('exportTradingJournalBtn').addEventListener('click', () => 
                exportTableToCSV('tradingJournalTable', 'trading_journal.csv')
            );
            document.getElementById('printTradingJournalBtn').addEventListener('click', () => 
                printTable('tradingJournalTable', 'Trading Journal')
            );
            document.getElementById('exportHoldingsSummaryBtn').addEventListener('click', () => 
                exportTableToCSV('holdingsSummaryTable', 'holdings_summary.csv')
            );
            document.getElementById('printHoldingsSummaryBtn').addEventListener('click', () => 
                printTable('holdingsSummaryTable', 'Holdings Summary')
            );
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        async function processFile() {
            const file = document.getElementById('excelFile').files[0];
            if (!file) {
                alert('Please select a file first');
                return;
            }

            try {
                const data = await readExcelFile(file);
                uploadedData = data;
                
                // Generate trading journal from uploaded data
                generateTradingJournalFromData(data);
                
                // Show analysis section
                document.getElementById('tradeAnalysisSection').classList.remove('hidden');
                document.getElementById('tradingJournalContainer').classList.remove('hidden');
                document.getElementById('portfolioHoldingsSummary').classList.remove('hidden');
                
                // Initialize DataTables
                initializeTradingJournalDataTable();
                initializeHoldingsSummaryDataTable();
                
                // Calculate and display totals after a short delay
                setTimeout(() => {
                    calculateAndDisplayTotals();
                }, 500);
                
                showNotification(`File processed successfully! Found ${data.length} trades.`, 'success');
                
            } catch (error) {
                console.error('Error processing file:', error);
                alert('Error processing file: ' + error.message);
            }
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Get the first worksheet
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // Convert to JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        // Process the data
                        const processedData = processExcelData(jsonData);
                        resolve(processedData);
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsArrayBuffer(file);
            });
        }

        function processExcelData(jsonData) {
            if (jsonData.length < 2) {
                throw new Error('Excel file must have at least a header and one data row');
            }

            const headers = jsonData[0];
            const trades = [];

            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (row.length === headers.length) {
                    const trade = {};
                    headers.forEach((header, index) => {
                        const value = row[index];
                        const cleanHeader = header.trim().toLowerCase();
                        
                        // Map trading history columns
                        if (cleanHeader === 'account') {
                            trade.account = value ? value.toString().trim() : '';
                        } else if (cleanHeader === 'date') {
                            trade.date = value ? value.toString().trim() : '';
                        } else if (cleanHeader === 'security') {
                            trade.security = value ? value.toString().trim() : '';
                        } else if (cleanHeader === 'description') {
                            trade.description = value ? value.toString().trim() : '';
                        } else if (cleanHeader === 'number of shares') {
                            trade.quantity = parseNumberWithCommas(value);
                        } else if (cleanHeader === 'price') {
                            trade.price = parseNumberWithCommas(value);
                        } else if (cleanHeader === 'settlement date') {
                            trade.settlementDate = value ? value.toString().trim() : '';
                        } else if (cleanHeader === 'status') {
                            trade.status = value ? value.toString().trim() : '';
                        } else {
                            // Store other fields as-is
                            trade[header.trim()] = value;
                        }
                    });
                    
                    if (trade.security && trade.quantity > 0 && trade.price > 0) {
                        trades.push(trade);
                    }
                }
            }

            return trades;
        }

        function parseNumberWithCommas(value) {
            if (value === null || value === undefined || value === '') return 0;
            
            // Convert to string and remove commas, spaces, and other formatting
            const cleanStr = value.toString().replace(/[,\s]/g, '');
            const num = parseFloat(cleanStr);
            return isNaN(num) ? 0 : num;
        }

        function generateTradingJournalFromData(trades) {
            const tbody = document.getElementById('tradingJournalTableBody');
            tbody.innerHTML = '';

            // Reset trades array
            allTrades = [];

            // Sort trades by date
            trades.sort((a, b) => new Date(a.date) - new Date(b.date));

            // Group trades by symbol to match buy/sell pairs
            const tradesBySymbol = {};
            trades.forEach(trade => {
                const symbol = trade.security;
                if (!tradesBySymbol[symbol]) {
                    tradesBySymbol[symbol] = [];
                }
                tradesBySymbol[symbol].push(trade);
            });

            // Process each symbol's trades to match buy/sell pairs
            Object.keys(tradesBySymbol).forEach(symbol => {
                const symbolTrades = tradesBySymbol[symbol];
                const buyTrades = [];
                const sellTrades = [];

                // Separate buy and sell trades
                symbolTrades.forEach(trade => {
                    const description = trade.description || '';
                    const isBuy = description.toLowerCase().includes('buy') || description.toLowerCase().includes('purchase');
                    const isSell = description.toLowerCase().includes('sale') || description.toLowerCase().includes('sell');
                    
                    if (isBuy) {
                        buyTrades.push(trade);
                    } else if (isSell) {
                        sellTrades.push(trade);
                    }
                });

                // First, add all buy trades to the journal
                buyTrades.forEach(buyTrade => {
                    const buyQuantity = parseFloat(buyTrade.quantity) || 0;
                    const buyPrice = parseFloat(buyTrade.price) || 0;
                    const buyBrokerage = (buyQuantity * buyPrice) * 0.0112;

                    const buyEntry = {
                        date: buyTrade.date,
                        symbol: symbol,
                        quantity: buyQuantity,
                        price: buyPrice,
                        avgBuyPrice: buyPrice,
                        totalValue: buyQuantity * buyPrice,
                        brokerage: buyBrokerage,
                        netValue: (buyQuantity * buyPrice) + buyBrokerage,
                        type: 'BUY',
                        description: buyTrade.description,
                        settlementDate: buyTrade.settlementDate,
                        status: buyTrade.status,
                        pnl: 0,
                        pnlPercent: 0,
                        soldDate: '',
                        duration: '',
                        soldPrice: 0,
                        sellOrderValue: 0,
                        isMatched: false
                    };

                    allTrades.push(buyEntry);
                });

                // Calculate weighted average buy price for all buy trades
                const totalBuyQuantity = buyTrades.reduce((sum, trade) => sum + (parseFloat(trade.quantity) || 0), 0);
                const totalBuyCost = buyTrades.reduce((sum, trade) => {
                    const qty = parseFloat(trade.quantity) || 0;
                    const price = parseFloat(trade.price) || 0;
                    return sum + (qty * price) + (qty * price * 0.0112); // Include brokerage
                }, 0);
                const weightedAvgBuyPrice = totalBuyQuantity > 0 ? totalBuyCost / totalBuyQuantity : 0;

                // Process each sell trade using weighted average
                sellTrades.forEach(sellTrade => {
                    const sellQuantity = parseFloat(sellTrade.quantity) || 0;
                    const sellPrice = parseFloat(sellTrade.price) || 0;
                    const sellBrokerage = (sellQuantity * sellPrice) * 0.0112;
                    const sellProceeds = (sellQuantity * sellPrice) - sellBrokerage;

                    // Use weighted average buy price for consistent P&L calculation
                    const avgBuyPrice = weightedAvgBuyPrice;
                    const buyCost = (sellQuantity * avgBuyPrice);
                    const pnl = sellProceeds - buyCost;
                    const pnlPercent = buyCost > 0 ? (pnl / buyCost) * 100 : 0;

                    // Calculate duration (use earliest buy date)
                    const sellDate = new Date(sellTrade.date);
                    const earliestBuyDate = buyTrades.length > 0 ? 
                        new Date(Math.min(...buyTrades.map(t => new Date(t.date)))) : sellDate;
                    const durationDays = Math.ceil((sellDate - earliestBuyDate) / (1000 * 60 * 60 * 24));

                    // Create sell entry with calculated values
                    const sellEntry = {
                        date: sellTrade.date,
                        symbol: symbol,
                        quantity: sellQuantity,
                        price: sellPrice, // Current sell price
                        avgBuyPrice: avgBuyPrice, // Weighted average buy price
                        totalValue: sellQuantity * sellPrice,
                        brokerage: sellBrokerage,
                        netValue: sellProceeds,
                        type: 'SELL',
                        description: sellTrade.description,
                        settlementDate: sellTrade.settlementDate,
                        status: sellTrade.status,
                        pnl: pnl,
                        pnlPercent: pnlPercent,
                        soldDate: sellTrade.date,
                        duration: durationDays,
                        soldPrice: sellPrice,
                        sellOrderValue: sellQuantity * sellPrice,
                        isMatched: true
                    };

                    allTrades.push(sellEntry);
                });
            });

            // Sort all trades by date
            allTrades.sort((a, b) => new Date(a.date) - new Date(b.date));

            // Create table rows
            allTrades.forEach(trade => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                // Color code based on trade type
                const typeColor = trade.type === 'BUY' ? 'bg-green-100 text-green-800' : 
                                 trade.type === 'SELL' ? 'bg-red-100 text-red-800' : 
                                 'bg-gray-100 text-gray-800';
                
                // P&L color coding
                const pnlColor = trade.pnl > 0 ? 'text-green-600' : trade.pnl < 0 ? 'text-red-600' : 'text-gray-500';
                const pnlPercentColor = trade.pnlPercent > 0 ? 'text-green-600' : trade.pnlPercent < 0 ? 'text-red-600' : 'text-gray-500';
                
                // Calculate annualized return
                let annualizedReturn = 0;
                if (trade.duration && trade.duration > 0 && trade.pnlPercent !== 0) {
                    const years = trade.duration / 365;
                    if (years > 0 && years < 10) { // Cap at 10 years to prevent astronomical values
                        annualizedReturn = Math.pow(1 + (trade.pnlPercent / 100), 1 / years) - 1;
                        annualizedReturn = annualizedReturn * 100; // Convert to percentage
                        // Cap annualized return at reasonable values
                        annualizedReturn = Math.min(Math.max(annualizedReturn, -1000), 1000);
                    }
                }
                const annualizedColor = annualizedReturn > 0 ? 'text-green-600' : annualizedReturn < 0 ? 'text-red-600' : 'text-gray-500';
                
                // For sell trades, show average buy price; for buy trades, show current price
                const displayPrice = trade.type === 'SELL' && trade.avgBuyPrice ? trade.avgBuyPrice : trade.price;
                
                row.innerHTML = `
                    <td class="px-3 py-2 text-sm text-gray-900">${trade.date}</td>
                    <td class="px-3 py-2 text-sm font-medium text-gray-900">${trade.symbol}</td>
                    <td class="px-3 py-2 text-sm text-gray-900 text-right">${formatNumber(trade.quantity, 0)}</td>
                    <td class="px-3 py-2 text-sm text-gray-900 text-right">Rs. ${formatNumber(displayPrice)}</td>
                    <td class="px-3 py-2 text-sm text-gray-900 text-right">Rs. ${formatNumber(trade.totalValue)}</td>
                    <td class="px-3 py-2 text-sm text-center">
                        <span class="px-2 py-1 text-xs font-medium ${typeColor} rounded-full">${trade.type}</span>
                    </td>
                    <td class="px-3 py-2 text-sm text-gray-500">${trade.soldDate}</td>
                    <td class="px-3 py-2 text-sm text-gray-500 text-right">${trade.duration ? trade.duration + ' days' : ''}</td>
                    <td class="px-3 py-2 text-sm text-gray-500 text-right">${trade.soldPrice > 0 ? 'Rs. ' + formatNumber(trade.soldPrice) : ''}</td>
                    <td class="px-3 py-2 text-sm text-gray-500 text-right">${trade.sellOrderValue > 0 ? 'Rs. ' + formatNumber(trade.sellOrderValue) : ''}</td>
                    <td class="px-3 py-2 text-sm text-right ${pnlColor}">
                        ${trade.pnl !== 0 ? formatNumber(trade.pnl) : ''}
                    </td>
                    <td class="px-3 py-2 text-sm text-right ${pnlPercentColor}">
                        ${trade.pnlPercent !== 0 ? formatNumber(trade.pnlPercent, 2) + '%' : ''}
                    </td>
                    <td class="px-3 py-2 text-sm text-right ${annualizedColor}">
                        ${annualizedReturn !== 0 ? formatNumber(annualizedReturn, 1) + '%' : ''}
                    </td>
                `;
                
                tbody.appendChild(row);
            });

            // Generate holdings summary from current positions
            generateHoldingsSummaryFromTrades(trades);
        }

        function generateHoldingsSummaryFromTrades(trades) {
            const tbody = document.getElementById('holdingsSummaryTableBody');
            tbody.innerHTML = '';

            // Calculate current holdings from trades
            const holdings = {};
            
            trades.forEach(trade => {
                const symbol = trade.security;
                const quantity = parseFloat(trade.quantity) || 0;
                const price = parseFloat(trade.price) || 0;
                const description = trade.description || '';
                
                // Determine trade type
                const isBuy = description.toLowerCase().includes('buy') || description.toLowerCase().includes('purchase');
                const isSell = description.toLowerCase().includes('sale') || description.toLowerCase().includes('sell');
                
                if (!holdings[symbol]) {
                    holdings[symbol] = {
                        symbol: symbol,
                        totalQuantity: 0,
                        totalCost: 0,
                        totalValue: 0,
                        lastPrice: 0
                    };
                }
                
                if (isBuy) {
                    holdings[symbol].totalQuantity += quantity;
                    holdings[symbol].totalCost += (quantity * price) + (quantity * price * 0.0112); // Include brokerage
                } else if (isSell) {
                    holdings[symbol].totalQuantity -= quantity;
                    holdings[symbol].totalCost -= (quantity * price) - (quantity * price * 0.0112); // Include brokerage
                }
                
                // Update last price (use the most recent price)
                holdings[symbol].lastPrice = price;
            });
            
            // Filter out zero or negative quantities (sold out positions)
            const currentHoldings = Object.values(holdings).filter(holding => holding.totalQuantity > 0);
            
            currentHoldings.forEach(holding => {
                const totalValue = holding.totalQuantity * holding.lastPrice;
                const avgCost = holding.totalQuantity > 0 ? holding.totalCost / holding.totalQuantity : 0;
                const unrealizedPnL = totalValue - holding.totalCost;
                const unrealizedPnLPercent = holding.totalCost > 0 ? (unrealizedPnL / holding.totalCost) * 100 : 0;

                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${holding.symbol}</td>
                    <td class="px-4 py-3 text-sm text-gray-900 text-right">${formatNumber(holding.totalQuantity, 0)}</td>
                    <td class="px-4 py-3 text-sm text-gray-900 text-right">Rs. ${formatNumber(avgCost)}</td>
                    <td class="px-4 py-3 text-sm text-gray-900 text-right">Rs. ${formatNumber(holding.lastPrice)}</td>
                    <td class="px-4 py-3 text-sm text-gray-900 text-right">Rs. ${formatNumber(totalValue)}</td>
                    <td class="px-4 py-3 text-sm text-right ${unrealizedPnL >= 0 ? 'text-green-600' : 'text-red-600'}">
                        Rs. ${formatNumber(unrealizedPnL)}
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function analyzeTrades() {
            // Use the allTrades array instead of parsing DOM
            let totalProfit = 0;
            let totalLoss = 0;
            let totalTrades = 0;
            let winningTrades = 0;
            let bestTrade = 0;
            let worstTrade = 0;
            
            // Only analyze matched trades (completed buy/sell pairs)
            const matchedTrades = allTrades.filter(trade => trade.isMatched && trade.type === 'SELL');
            
            matchedTrades.forEach(trade => {
                const pnl = trade.pnl || 0;
                
                if (pnl !== 0) {
                    totalTrades++;
                    
                    if (pnl > 0) {
                        totalProfit += pnl;
                        winningTrades++;
                        bestTrade = Math.max(bestTrade, pnl);
                    } else if (pnl < 0) {
                        totalLoss += Math.abs(pnl);
                        worstTrade = Math.min(worstTrade, pnl);
                    }
                }
            });
            
            const netPnL = totalProfit - totalLoss;
            const winRate = totalTrades > 0 ? (winningTrades / totalTrades) * 100 : 0;
            const avgProfitPerTrade = totalTrades > 0 ? netPnL / totalTrades : 0;
            
            // Update results display
            document.getElementById('totalProfit').textContent = `Rs. ${formatNumber(totalProfit)}`;
            document.getElementById('totalLoss').textContent = `Rs. ${formatNumber(totalLoss)}`;
            document.getElementById('netPnL').textContent = `Rs. ${formatNumber(netPnL)}`;
            document.getElementById('winRate').textContent = `${formatNumber(winRate, 1)}%`;
            document.getElementById('totalTrades').textContent = totalTrades.toString();
            document.getElementById('avgProfitPerTrade').textContent = `Rs. ${formatNumber(avgProfitPerTrade)}`;
            document.getElementById('bestTrade').textContent = `Rs. ${formatNumber(bestTrade)}`;
            document.getElementById('worstTrade').textContent = `Rs. ${formatNumber(worstTrade)}`;
            
            // Show results
            document.getElementById('tradingPerformanceSummary').classList.remove('hidden');
        }

        function initializeTradingJournalDataTable() {
            if ($.fn.DataTable.isDataTable('#tradingJournalTable')) {
                $('#tradingJournalTable').DataTable().destroy();
            }
            
            $('#tradingJournalTable').DataTable({
                pageLength: 25,
                order: [[0, 'desc']], // Sort by date descending
                columnDefs: [
                    { targets: [2, 3, 4, 7, 8, 9, 10, 11, 12], className: 'text-right' },
                    { targets: [5], className: 'text-center' },
                    { targets: [12], width: '80px' } // Make annualized return column narrower
                ],
                dom: 'Bfrtip',
                buttons: [
                    'copy', 'csv', 'excel', 'pdf', 'print'
                ],
                footerCallback: function (row, data, start, end, display) {
                    var api = this.api();
                    
                    // Calculate totals for P&L columns (only for SELL trades)
                    var totalPnL = 0;
                    var totalPnLPercent = 0;
                    var totalAnnualizedReturn = 0;
                    var sellTradeCount = 0;
                    
                    api.rows({ page: 'current' }).every(function () {
                        var rowData = this.data();
                        var tradeType = rowData[5].replace(/<[^>]*>/g, '').trim(); // Remove HTML tags
                        var pnlText = rowData[10].replace(/<[^>]*>/g, '').replace(/,/g, '');
                        var pnlPercentText = rowData[11].replace(/<[^>]*>/g, '').replace('%', '');
                        var annualizedText = rowData[12].replace(/<[^>]*>/g, '').replace('%', '');
                        
                        if (tradeType === 'SELL') {
                            var pnl = parseFloat(pnlText) || 0;
                            var pnlPercent = parseFloat(pnlPercentText) || 0;
                            var annualized = parseFloat(annualizedText) || 0;
                            
                            totalPnL += pnl;
                            totalPnLPercent += pnlPercent;
                            totalAnnualizedReturn += annualized;
                            sellTradeCount++;
                        }
                    });
                    
                    // Update footer
                    $(api.column(10).footer()).html(formatNumber(totalPnL));
                    $(api.column(11).footer()).html(formatNumber(totalPnLPercent, 2) + '%');
                    $(api.column(12).footer()).html(sellTradeCount > 0 ? formatNumber(totalAnnualizedReturn / sellTradeCount, 1) + '%' : '0%');
                },
                drawCallback: function() {
                    // Add footer row if it doesn't exist
                    if ($('#tradingJournalTable tfoot').length === 0) {
                        $('#tradingJournalTable').append(`
                            <tfoot>
                                <tr class="bg-gray-100 font-semibold">
                                    <td class="text-right">Total (SELL trades only):</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td class="text-right">0</td>
                                    <td class="text-right">0%</td>
                                    <td class="text-right">0%</td>
                                </tr>
                            </tfoot>
                        `);
                    }
                    
                    // Update totals when table is redrawn (search/filter)
                    setTimeout(() => {
                        calculateAndDisplayTotals();
                    }, 200);
                },
                initComplete: function() {
                    // Force footer callback to run after initialization
                    this.api().draw();
                }
            });
        }

        function initializeHoldingsSummaryDataTable() {
            if ($.fn.DataTable.isDataTable('#holdingsSummaryTable')) {
                $('#holdingsSummaryTable').DataTable().destroy();
            }
            
            $('#holdingsSummaryTable').DataTable({
                pageLength: 25,
                order: [[4, 'desc']], // Sort by market value descending
                columnDefs: [
                    { targets: [1, 2, 3, 4, 5], className: 'text-right' }
                ],
                dom: 'Bfrtip',
                buttons: [
                    'copy', 'csv', 'excel', 'pdf', 'print'
                ]
            });
        }

        function clearData() {
            uploadedData = [];
            allTrades = [];
            processedStocks.clear();
            
            document.getElementById('excelFile').value = '';
            document.getElementById('fileName').textContent = 'No file selected';
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('tradeAnalysisSection').classList.add('hidden');
            
            // Destroy DataTables
            if ($.fn.DataTable.isDataTable('#tradingJournalTable')) {
                $('#tradingJournalTable').DataTable().destroy();
            }
            if ($.fn.DataTable.isDataTable('#holdingsSummaryTable')) {
                $('#holdingsSummaryTable').DataTable().destroy();
            }
            
            // Clear tables
            document.getElementById('tradingJournalTableBody').innerHTML = '';
            document.getElementById('holdingsSummaryTableBody').innerHTML = '';
            
            // Reset performance summary
            document.getElementById('tradingPerformanceSummary').classList.add('hidden');
        }

        function calculateAndDisplayTotals() {
            // Get visible rows from DataTable (filtered data)
            const table = $('#tradingJournalTable').DataTable();
            const visibleData = table.rows({ search: 'applied' }).data().toArray();
            
            let totalPnL = 0;
            let totalBuyCost = 0;
            let totalSellProceeds = 0;
            let totalAnnualizedReturn = 0;
            let validAnnualizedCount = 0;
            let sellTradeCount = 0;
            
            visibleData.forEach((rowData, index) => {
                // Extract trade type from HTML (handle both string and jQuery object)
                let tradeTypeText;
                if (typeof rowData[5] === 'string') {
                    // Extract text from HTML string
                    tradeTypeText = rowData[5].replace(/<[^>]*>/g, '').trim();
                } else {
                    // Handle jQuery object
                    tradeTypeText = $(rowData[5]).text().trim();
                }
                const tradeType = tradeTypeText;
                
                if (tradeType === 'SELL') {
                    sellTradeCount++;
                    
                    // Extract values from HTML (handle both string and jQuery object)
                    const quantityText = typeof rowData[2] === 'string' ? rowData[2] : $(rowData[2]).text();
                    const avgPriceText = typeof rowData[3] === 'string' ? rowData[3] : $(rowData[3]).text();
                    const soldPriceText = typeof rowData[8] === 'string' ? rowData[8] : $(rowData[8]).text();
                    const pnlText = typeof rowData[10] === 'string' ? rowData[10] : $(rowData[10]).text();
                    const pnlPercentText = typeof rowData[11] === 'string' ? rowData[11] : $(rowData[11]).text();
                    const annualizedText = typeof rowData[12] === 'string' ? rowData[12] : $(rowData[12]).text();
                    
                    const quantity = parseFloat(quantityText.replace(/,/g, '')) || 0;
                    const avgPrice = parseFloat(avgPriceText.replace('Rs. ', '').replace(/,/g, '')) || 0;
                    const soldPrice = parseFloat(soldPriceText.replace('Rs. ', '').replace(/,/g, '')) || 0;
                    const pnl = parseFloat(pnlText.replace(/,/g, '')) || 0;
                    const pnlPercent = parseFloat(pnlPercentText.replace('%', '')) || 0;
                    const annualized = parseFloat(annualizedText.replace('%', '')) || 0;
                    
                    totalPnL += pnl;
                    
                    // Calculate buy cost and sell proceeds (consistent with individual trade calculation)
                    const sellProceeds = (quantity * soldPrice) - ((quantity * soldPrice) * 0.0112);
                    const buyCost = (quantity * avgPrice); // No brokerage added to buy cost, consistent with individual trades
                    
                    totalBuyCost += buyCost;
                    totalSellProceeds += sellProceeds;
                    
                    if (!isNaN(annualized) && annualized !== 0) {
                        totalAnnualizedReturn += annualized;
                        validAnnualizedCount++;
                    }
                }
            });
            
            // Calculate proper total P&L% using the same method as individual trades
            const totalPnLPercent = totalBuyCost > 0 ? (totalPnL / totalBuyCost) * 100 : 0;
            
            // Calculate overall annualized return based on weighted average of individual trades
            let overallAnnualizedReturn = 0;
            if (validAnnualizedCount > 0) {
                // Calculate weighted average based on P&L amounts
                let weightedSum = 0;
                let totalWeight = 0;
                
                visibleData.forEach((rowData) => {
                    const tradeTypeText = typeof rowData[5] === 'string' ? 
                        rowData[5].replace(/<[^>]*>/g, '').trim() : 
                        $(rowData[5]).text().trim();
                    
                    if (tradeTypeText === 'SELL') {
                        const pnlText = typeof rowData[10] === 'string' ? rowData[10] : $(rowData[10]).text();
                        const annualizedText = typeof rowData[12] === 'string' ? rowData[12] : $(rowData[12]).text();
                        
                        const pnl = parseFloat(pnlText.replace(/,/g, '')) || 0;
                        // Clean the annualized text more thoroughly
                        const cleanAnnualizedText = annualizedText.replace(/[^\d.-]/g, ''); // Remove all non-numeric characters except decimal point and minus
                        const annualized = parseFloat(cleanAnnualizedText) || 0;
                        
                        if (!isNaN(annualized) && annualized !== 0 && pnl !== 0) {
                            const weight = Math.abs(pnl); // Use absolute P&L as weight
                            weightedSum += annualized * weight;
                            totalWeight += weight;
                        }
                    }
                });
                
                overallAnnualizedReturn = totalWeight > 0 ? weightedSum / totalWeight : 0;
            }
            
            // Update footer directly
            const tfoot = document.querySelector('#tradingJournalTable tfoot');
            if (tfoot) {
                const cells = tfoot.querySelectorAll('td');
                if (cells.length >= 13) {
                    cells[10].textContent = formatNumber(totalPnL);
                    cells[11].textContent = formatNumber(totalPnLPercent, 2) + '%';
                    cells[12].textContent = overallAnnualizedReturn > 0 ? formatNumber(overallAnnualizedReturn, 1) + '%' : '0%';
                }
            }
        }

        function showNotification(message, type = 'info') {
            // Simple notification - you can enhance this with a proper notification system
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function formatNumber(number, decimals = 2) {
            if (isNaN(number)) return '0.00';
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(number);
        }

        function exportTableToCSV(tableId, filename) {
            const table = document.getElementById(tableId);
            const rows = Array.from(table.querySelectorAll('tr'));
            
            let csv = rows.map(row => {
                return Array.from(row.querySelectorAll('th, td'))
                    .map(cell => `"${cell.textContent.trim()}"`)
                    .join(',');
            }).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function printTable(tableId, title) {
            const table = document.getElementById(tableId);
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>${title}</title>
                        <style>
                            body { font-family: Arial, sans-serif; }
                            table { border-collapse: collapse; width: 100%; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                        </style>
                    </head>
                    <body>
                        <h1>${title}</h1>
                        ${table.outerHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
    </script>

    <!-- Footer -->
    <footer class="bg-white border-t mt-16">
        <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <!-- Brand Section -->
                <div class="col-span-1 md:col-span-2">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chart-line text-white text-lg"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">PortfolioPro</h3>
                            <p class="text-sm text-gray-600">Professional Portfolio Management</p>
                        </div>
                    </div>
                    <p class="text-gray-600 text-sm leading-relaxed">
                        A comprehensive portfolio management platform designed for professional investors. 
                        Track, analyze, and optimize your investment portfolio with advanced analytics and insights.
                    </p>
                </div>

                <!-- Quick Links -->
                <div>
                    <h4 class="text-gray-900 font-semibold mb-4">Quick Links</h4>
                    <ul class="space-y-2">
                        <li><a href="index.html" class="text-gray-600 hover:text-gray-900 transition-colors text-sm">Portfolio Dashboard</a></li>
                        <li><a href="calculator.html" class="text-gray-600 hover:text-gray-900 transition-colors text-sm">Stock Calculator</a></li>
                        <li><a href="targets.html" class="text-gray-600 hover:text-gray-900 transition-colors text-sm">Target Prices</a></li>
                        <li><a href="transactions.html" class="text-gray-600 hover:text-gray-900 transition-colors text-sm">Transaction History</a></li>
                        <li><a href="tradelog.html" class="text-gray-600 hover:text-gray-900 transition-colors text-sm">TradeLog Analysis</a></li>
                    </ul>
                </div>

                <!-- Support & Resources -->
                <div>
                    <h4 class="text-gray-900 font-semibold mb-4">Support & Resources</h4>
                    <ul class="space-y-2">
                        <li><a href="docs.html" class="text-gray-600 hover:text-gray-900 transition-colors text-sm">Documentation</a></li>
                        <li><a href="help.html" class="text-gray-600 hover:text-gray-900 transition-colors text-sm">Help Center</a></li>
                        <li><a href="tutorials.html" class="text-gray-600 hover:text-gray-900 transition-colors text-sm">Tutorials</a></li>
                        <li><a href="contact.html" class="text-gray-600 hover:text-gray-900 transition-colors text-sm">Contact Support</a></li>
                    </ul>
                </div>
            </div>

            <!-- Bottom Section -->
            <div class="border-t border-gray-200 mt-8 pt-8">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <p class="text-gray-600 text-sm">
                        © 2024 PortfolioPro. All rights reserved.
                    </p>
                    <div class="flex space-x-6 mt-4 md:mt-0">
                        <a href="https://github.com" class="text-gray-600 hover:text-gray-900 transition-colors" title="GitHub">
                            <i class="fab fa-github"></i>
                        </a>
                        <a href="mailto:support@portfoliopro.com" class="text-gray-600 hover:text-gray-900 transition-colors" title="Email Support">
                            <i class="fas fa-envelope"></i>
                        </a>
                        <a href="docs.html" class="text-gray-600 hover:text-gray-900 transition-colors" title="Documentation">
                            <i class="fas fa-book"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </footer>
</body>
</html>
