<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Calculator - Portfolio Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .card-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .input-focus:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .profit-text {
            color: #10b981;
        }

        .loss-text {
            color: #ef4444;
        }

        /* Ensure navigation buttons display properly */
        .nav-button {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            border: none;
            cursor: pointer;
        }

        .nav-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Ensure Font Awesome icons display properly */
        .fas,
        .far,
        .fab {
            font-family: "Font Awesome 6 Free", "Font Awesome 6 Pro", "Font Awesome 5 Free", "Font Awesome 5 Pro", "FontAwesome" !important;
            font-weight: 900 !important;
            font-style: normal !important;
            font-variant: normal !important;
            text-rendering: auto !important;
            line-height: 1 !important;
            -webkit-font-smoothing: antialiased !important;
            -moz-osx-font-smoothing: grayscale !important;
            display: inline-block !important;
        }

        /* Specific icon fixes */
        .fa-chart-pie:before {
            content: "\f200";
        }

        .fa-calculator:before {
            content: "\f1ec";
        }

        .fa-bullseye:before {
            content: "\f140";
        }

        .fa-exchange-alt:before {
            content: "\f362";
        }

        .fa-cog:before {
            content: "\f013";
        }

        .fa-bars:before {
            content: "\f0c9";
        }

        .fa-chart-line:before {
            content: "\f201";
        }

        .neutral-text {
            color: #6b7280;
        }

        .sort-icon {
            margin-left: 0.25rem;
            font-size: 0.875rem;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        th:hover .sort-icon {
            opacity: 1;
        }

        #symbolSuggestions {
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
        }

        #symbolSuggestions div:first-child {
            border-radius: 0.5rem 0.5rem 0 0;
        }

        #symbolSuggestions div:last-child {
            border-radius: 0 0 0.5rem 0.5rem;
        }

        #symbolSuggestions div:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3 cursor-pointer" onclick="window.location.href='index.html'">
                    <div
                        class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-line text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">PortfolioPro</h1>
                        <p class="text-sm text-gray-600">Professional Portfolio Management</p>
                    </div>
                </div>
                <nav class="hidden md:flex space-x-2">
                    <button onclick="window.location.href='index.html'"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fas fa-chart-pie mr-2"></i>Portfolio
                    </button>
                    <button onclick="window.location.href='calculator.html'"
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors shadow-lg flex items-center">
                        <i class="fas fa-calculator mr-2"></i>Calculator
                    </button>
                    <button onclick="window.location.href='targets.html'"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fas fa-bullseye mr-2"></i>Targets
                    </button>
                    <button onclick="window.location.href='transactions.html'"
                        class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fas fa-exchange-alt mr-2"></i>Transactions
                    </button>
                    <button onclick="window.location.href='settings.html'"
                        class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </button>
                </nav>

                <!-- Mobile Menu Button -->
                <button id="mobileMenuBtn"
                    class="md:hidden text-gray-600 p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>

            <!-- Mobile Navigation -->
            <div id="mobileMenu" class="md:hidden hidden pb-4">
                <div class="flex flex-col space-y-2">
                    <button onclick="window.location.href='index.html'"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fas fa-chart-pie mr-2"></i>Portfolio
                    </button>
                    <button onclick="window.location.href='calculator.html'"
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors shadow-lg flex items-center">
                        <i class="fas fa-calculator mr-2"></i>Calculator
                    </button>
                    <button onclick="window.location.href='targets.html'"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fas fa-bullseye mr-2"></i>Targets
                    </button>
                    <button onclick="window.location.href='transactions.html'"
                        class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fas fa-exchange-alt mr-2"></i>Transactions
                    </button>
                    <button onclick="window.location.href='settings.html'"
                        class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-8">
        <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
            <!-- Main Calculator -->
            <div class="xl:col-span-1">
                <!-- Calculator Tabs -->
                <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                    <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg mb-6">
                        <button id="buySellTab" onclick="switchTab('buySell')"
                            class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors bg-white text-blue-600 shadow-sm">
                            <i class="fas fa-exchange-alt mr-2"></i>Buy/Sell Calculator
                        </button>
                        <button id="avgPriceTab" onclick="switchTab('avgPrice')"
                            class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900">
                            <i class="fas fa-calculator mr-2"></i>Average Price Calculator
                        </button>
                    </div>

                    <!-- Buy/Sell Calculator Section -->
                    <div id="buySellSection">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900">Buy/Sell Calculator</h2>
                                    <p class="text-gray-600">Calculate buy/sell returns with brokerage options</p>
                                </div>
                            </div>
                            <button onclick="clearAll()"
                                class="p-3 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
                                title="Reset all fields">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                    </path>
                                </svg>
                            </button>
                        </div>

                        <div class="space-y-4">
                            <!-- Stock Symbol -->
                            <div class="relative">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Stock Symbol</label>
                                <input type="text" id="stockSymbol" placeholder="e.g., JKH.N"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent input-focus text-sm"
                                    autocomplete="off">
                                <div id="symbolSuggestions"
                                    class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto hidden">
                                    <!-- Suggestions will be populated here -->
                                </div>
                            </div>

                            <!-- Quantity -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Quantity (Shares)</label>
                                <input type="number" id="quantity" placeholder="0" min="0" value="1000"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent input-focus text-sm">
                            </div>

                            <!-- Buy Price with Average Toggle -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Buy Price (Rs.)</label>
                                <div class="flex gap-2">
                                    <input type="number" id="buyPrice" placeholder="0.00" step="0.25" min="0"
                                        class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent input-focus text-sm">
                                    <div class="flex items-center bg-gray-50 border border-gray-200 rounded-lg px-3">
                                        <span class="text-xs text-gray-700 mr-2">Avg</span>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="useAvgPrice" class="sr-only peer">
                                            <div
                                                class="w-8 h-4 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-blue-600">
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Sell Price -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sell Price (Rs.)</label>
                                <input type="number" id="sellPrice" placeholder="0.00" step="0.25" min="0"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent input-focus text-sm">
                            </div>
                        </div>

                        <!-- Results Display -->
                        <div id="calculationResults" class="mt-6 hidden">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div id="resultsContent" class="text-center">
                                    <!-- Results will be displayed here -->
                                </div>
                                <div id="saveButtonContainer" class="mt-4 flex justify-center hidden">
                                    <button onclick="saveToTable()"
                                        class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors">
                                        Save to Table
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Brokerage Information -->
                        <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="text-sm text-blue-800 font-medium">Brokerage Information</span>
                            </div>
                            <p class="text-sm text-blue-700 mt-1" id="brokerageInfo">1.12% brokerage fee for buy and
                                sell transactions</p>
                        </div>
                    </div>

                    <!-- Average Price Calculator Section -->
                    <div id="avgPriceSection" class="hidden">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900">Average Price Calculator</h2>
                                    <p class="text-gray-600">Calculate new average price when buying additional shares
                                    </p>
                                </div>
                            </div>
                            <button onclick="clearAvgPriceAll()"
                                class="p-3 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
                                title="Reset all fields">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                    </path>
                                </svg>
                            </button>
                        </div>

                        <!-- Calculation Mode Toggle -->
                        <div class="mb-6">
                            <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
                                <button id="avgPriceModeBtn" onclick="switchAvgPriceMode('calculate')"
                                    class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors bg-white text-green-600 shadow-sm">
                                    <i class="fas fa-calculator mr-2"></i>Calculate New Avg Price
                                </button>
                                <button id="quantityModeBtn" onclick="switchAvgPriceMode('quantity')"
                                    class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900">
                                    <i class="fas fa-shopping-cart mr-2"></i>Calculate Required Quantity
                                </button>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <!-- Stock Symbol -->
                            <div class="relative">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Stock Symbol</label>
                                <input type="text" id="avgStockSymbol" placeholder="e.g., JKH.N"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent input-focus text-sm"
                                    autocomplete="off">
                                <div id="avgSymbolSuggestions"
                                    class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto hidden">
                                    <!-- Suggestions will be populated here -->
                                </div>
                            </div>

                            <!-- Current Holdings -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h3 class="text-sm font-semibold text-gray-700 mb-3">Current Holdings</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">Current
                                            Quantity</label>
                                        <input type="number" id="currentQuantity" placeholder="0" min="0"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent input-focus text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">Current Avg Price
                                            </label>
                                        <input type="number" id="currentAvgPrice" placeholder="0.00" step="0.01" min="0"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent input-focus text-sm">
                                    </div>
                                </div>
                            </div>

                            <!-- Mode 1: Calculate New Average Price -->
                            <div id="calculateMode" class="bg-green-50 rounded-lg p-4">
                                <h3 class="text-sm font-semibold text-gray-700 mb-3">New Purchase</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">New Quantity</label>
                                        <input type="number" id="newQuantity" placeholder="0" min="0"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent input-focus text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">New Price
                                            (Rs.)</label>
                                        <input type="number" id="newPrice" placeholder="0.00" step="0.25" min="0"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent input-focus text-sm">
                                    </div>
                                </div>
                            </div>

                            <!-- Mode 2: Calculate Required Quantity -->
                            <div id="quantityMode" class="bg-blue-50 rounded-lg p-4 hidden">
                                <h3 class="text-sm font-semibold text-gray-700 mb-3">Target Parameters</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">Target Avg Price</label>
                                        <input type="number" id="targetAvgPrice" placeholder="0.00" step="0.01" min="0"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent input-focus text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-600 mb-2">Buy Price (Rs.)</label>
                                        <input type="number" id="currentMarketPrice" placeholder="0.00" step="0.25" min="0"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent input-focus text-sm">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Average Price Results -->
                        <div id="avgPriceResults" class="mt-6 hidden">
                            <div class="bg-green-50 rounded-lg p-4">
                                <div id="avgPriceContent" class="text-center">
                                    <!-- Results will be displayed here -->
                                </div>
                                <div id="avgPriceSaveButtonContainer" class="mt-4 flex justify-center hidden">
                                    <button onclick="saveAvgPriceToTable()"
                                        class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors">
                                        Save to Table
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Calculation Information -->
                        <div class="mt-6 bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <span class="text-sm text-green-800 font-medium">Calculation Methods</span>
                            </div>
                            <div class="text-sm text-green-700 mt-1 space-y-1">
                                <p><strong>Mode 1:</strong> New Avg Price = (Current Qty × Current Price + New Qty × New Price + 1.12% Brokerage) ÷ Total Qty</p>
                                <p><strong>Mode 2:</strong> Required Qty = (Current Qty × (Target Avg - Current Avg)) ÷ (Market Price + 1.12% Brokerage - Target Avg)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Saved Calculations Sidebar -->
            <div class="xl:col-span-3">
                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Saved Calculations</h3>
                        <div class="flex space-x-2">
                            <button onclick="exportToJSON()"
                                class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-3 rounded-lg transition-colors">
                                Export JSON
                            </button>
                            <button onclick="importFromJSON()"
                                class="bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-2 px-3 rounded-lg transition-colors">
                                Import JSON
                            </button>
                            <button onclick="clearSavedCalculations()"
                                class="text-red-600 hover:text-red-700 text-sm font-medium transition-colors">
                                Clear All
                            </button>
                        </div>
                    </div>

                    <!-- Summary Stats -->
                    <div id="summaryStats" class="mb-4 p-4 bg-gray-50 rounded-lg hidden">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="text-center">
                                <div class="text-gray-600">Total P&L</div>
                                <div id="totalPnL" class="text-lg font-semibold">Rs. 0.00</div>
                            </div>
                            <div class="text-center">
                                <div class="text-gray-600">Avg Return %</div>
                                <div id="avgReturn" class="text-lg font-semibold">0.00%</div>
                            </div>
                        </div>
                    </div>

                    <div id="savedCalculationsTable" class="space-y-3">
                        <div class="text-center text-gray-500 py-8">
                            No saved calculations yet
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Utility functions
        function formatNumber(number, decimals = 2) {
            if (number === null || number === undefined || isNaN(number)) return '0';
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(number);
        }

        // Dynamic step adjustment function for price fields
        function adjustPriceStep(inputElement) {
            const value = parseFloat(inputElement.value) || 0;
            const newStep = value < 100 ? '0.1' : '0.25';
            inputElement.step = newStep;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'LKR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        // Brokerage fee constant
        const BROKERAGE_PERCENTAGE = 0.0112; // 1.12%

        // Stock symbols for autocomplete
        const STOCK_SYMBOLS = [
            "JKH.N", "COMB.N", "COMB.X", "CTC.N", "DIST.N", "LOLC.N", "DIAL.N", "MELS.N", "HNB.N", "HNB.X",
            "CARG.N", "LOFC.N", "SAMP.N", "CARS.N", "HAYL.N", "CTHR.N", "LION.N", "SLTL.N", "CCS.N", "VONE.N",
            "BIL.N", "BUKI.N", "NTB.N", "NTB.X", "HHL.N", "SINS.N", "LFIN.N", "CINS.N", "CINS.X", "DFCC.N",
            "CFIN.N", "LIOC.N", "SPEN.N", "AEL.N", "CIC.N", "CIC.X", "NDB.N", "SUN.N", "PLC.N", "SEYB.N",
            "SEYB.X", "GLAS.N", "RICH.N", "BREW.N", "SFCL.N", "RCL.N", "ACL.N", "OSEA.N", "PKME.N", "GREG.N",
            "UAL.N", "COCR.N", "WATA.N", "LLUB.N", "DIPD.N", "WIND.N", "AHUN.N", "ASIR.N", "TKYO.N", "TKYO.X",
            "BRWN.N", "KHL.N", "CALH.N", "PALM.N", "TAP.N", "HAYC.N", "PLR.N", "TJL.N", "PABC.N", "RIL.N",
            "AHPL.N", "VFIN.N", "JINS.N", "LMF.N", "KCAB.N", "CDB.N", "CDB.X", "CFVF.N", "UML.N", "GUAR.N",
            "AAIC.N", "CTEA.N", "JAT.N", "LAMB.N", "EDEN.N", "FCT.N", "GRAN.N", "LHCL.N", "DIMO.N", "CFLB.N",
            "LGL.N", "LGL.X", "UBC.N", "VLL.N", "VLL.X", "PAP.N", "MGT.N", "HUNA.N", "HNBF.N", "HNBF.X",
            "CALT.N", "EBCR.N", "KHC.N", "ABL.N", "HASU.N", "LWL.N", "SIRA.N", "ELPL.N", "NAMU.N", "TILE.N",
            "TAFL.N", "TRAN.N", "MAL.N", "MAL.X", "SFIN.N", "ALLI.N", "ALUM.N", "VPEL.N", "JETS.N", "PARQ.N",
            "CINV.N", "ASHO.N", "NHL.N", "AGPL.N", "SERV.N", "GHLL.N", "LGIL.N", "BFN.N", "SHOT.N", "SHOT.X",
            "AGAL.N", "RCH.N", "CALF.N", "NEH.N", "SHL.N", "UBF.N", "HARI.N", "CBNK.N", "DOCK.N", "CHOT.N",
            "EAST.N", "CLND.N", "BOGA.N", "LVEF.N", "TPL.N", "SDB.N", "PINS.N", "TAJ.N", "AAF.N", "AAF.P",
            "MERC.N", "CHL.N", "CHL.X", "AMF.N", "RWSL.N", "COOP.N", "TYRE.N", "BOPL.N", "CSLK.N", "COLO.N",
            "HPL.N", "AMSL.N", "SMOT.N", "APLA.N", "KVAL.N", "PMB.N", "ODEL.N", "MASK.N", "BFL.N", "BPPL.N",
            "LCBF.N", "RHL.N", "RHL.X", "ABAN.N", "RENU.N", "ASCO.N", "LPL.N", "LPL.X", "CIND.N", "SOY.N",
            "SCAP.N", "LCEY.N", "SEMB.N", "SEMB.X", "HELA.N", "CRL.N", "CARE.N", "JKL.N", "AFSL.N", "PACK.N",
            "BALA.N", "MBSL.N", "LDEV.N", "HUNT.N", "ATL.N", "CONN.N", "LVEN.N", "SDF.N", "ONAL.N", "SHAW.N",
            "CWM.N", "AGST.N", "AGST.X", "RAL.N", "COCO.N", "COCO.X", "KFP.N", "PHAR.N", "STAF.N", "REXP.N",
            "LHL.N", "RPBH.N", "CSD.N", "HPWR.N", "RHTL.N", "SINH.N", "LALU.N", "UDPL.N", "BBH.N", "KGAL.N",
            "HAPU.N", "HBS.N", "KZOO.N", "KOTA.N", "LITE.N", "DPL.N", "CABO.N", "CTLD.N", "CHMX.N", "MARA.N",
            "TANG.N", "COMD.N", "REEF.N", "HDFC.N", "BERU.N", "CIT.N", "CFI.N", "WAPO.N", "ETWO.N", "ASIY.N",
            "ATLL.N", "AINS.N", "KAHA.N", "MADU.N", "HEXP.N", "SWAD.N", "HSIG.N", "PEG.N", "CITW.N", "CITH.N",
            "AUTO.N", "ECL.N", "LUMX.N", "MCPL.N", "UCAR.N", "HPFL.N", "HOPL.N", "TSML.N", "MSL.N", "MFPE.N",
            "CTBL.N", "ASPH.N", "SIL.N", "BRR.N", "KPHL.N", "EMER.N", "SIGV.N", "TESS.N", "TESS.X", "MRH.N",
            "CERA.N", "AFS.N", "MHDL.N", "RFL.N", "LPRT.N", "HVA.N", "CSF.N", "MDL.N", "SLND.N", "ACME.N",
            "ACAP.N", "MULL.N", "GEST.N", "MEL.N", "EXT.N", "EML.N", "CWL.N", "SING.N", "BLUE.N", "CPRT.N",
            "RGEM.N", "YORK.N", "OFEQ.N", "PARA.N"
        ];

        // Global variable to store current calculation
        let currentCalculation = null;
        let currentAvgPriceCalculation = null;
        let autoFillTimeout = null;

        // Tab switching functionality
        function switchTab(tabName) {
            const buySellTab = document.getElementById('buySellTab');
            const avgPriceTab = document.getElementById('avgPriceTab');
            const buySellSection = document.getElementById('buySellSection');
            const avgPriceSection = document.getElementById('avgPriceSection');

            if (tabName === 'buySell') {
                buySellTab.className = 'flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors bg-white text-blue-600 shadow-sm';
                avgPriceTab.className = 'flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900';
                buySellSection.classList.remove('hidden');
                avgPriceSection.classList.add('hidden');
            } else if (tabName === 'avgPrice') {
                buySellTab.className = 'flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900';
                avgPriceTab.className = 'flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors bg-white text-green-600 shadow-sm';
                buySellSection.classList.add('hidden');
                avgPriceSection.classList.remove('hidden');
            }
        }

        // Portfolio data lookup functions
        function getPortfolioData() {
            // Try to get from window.combinedPortfolios first (this has the actual holdings)
            if (window.combinedPortfolios && window.combinedPortfolios.length > 0) {
                return window.combinedPortfolios;
            }
            
            // Try to get from window.individualPortfolios
            if (window.individualPortfolios && window.individualPortfolios.length > 0) {
                return window.individualPortfolios;
            }
            
            // Try to get from window.allUploadedData (flattened holdings)
            if (window.allUploadedData && window.allUploadedData.length > 0) {
                // Convert to portfolio format
                return [{
                    name: 'Combined Holdings',
                    holdings: window.allUploadedData
                }];
            }
            
            // Try to get from window.portfolioData
            if (window.portfolioData && window.portfolioData.length > 0) {
                // Convert to portfolio format
                return [{
                    name: 'Portfolio Data',
                    holdings: window.portfolioData
                }];
            }
            
            // Try to get from localStorage - check for any stored portfolio data
            const possibleKeys = ['portfolioData', 'allUploadedData', 'combinedPortfolios', 'individualPortfolios', 'portfolios', 'portfolio_backup_data'];
            
            for (let key of possibleKeys) {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        
                        if (Array.isArray(parsed)) {
                            if (parsed.length > 0) {
                                return parsed;
                            }
                        } else if (parsed.holdings) {
                            return [parsed];
                        } else if (key === 'portfolio_backup_data') {
                            // This is the backup data structure - extract portfolios from it
                            const portfolioKeys = Object.keys(parsed).filter(k => 
                                parsed[k] && typeof parsed[k] === 'object' && 
                                (parsed[k].holdings || parsed[k].name)
                            );
                            
                            if (portfolioKeys.length > 0) {
                                const portfolios = portfolioKeys.map(k => parsed[k]);
                                return portfolios;
                            }
                        }
                    } catch (e) {
                        // Ignore parsing errors
                    }
                }
            }
            
            return [];
        }

        function findStockInPortfolio(symbol) {
            const portfolios = getPortfolioData();
            
            // Look through all portfolios to find the stock
            for (let portfolio of portfolios) {
                if (portfolio.holdings && portfolio.holdings.length > 0) {
                    const holding = portfolio.holdings.find(h => {
                        const holdingSymbol = h.symbol || h.security;
                        if (!holdingSymbol) return false;
                        
                        const holdingSymbolUpper = holdingSymbol.toUpperCase();
                        const searchSymbolUpper = symbol.toUpperCase();
                        
                        // Direct match
                        const directMatch = holdingSymbolUpper === searchSymbolUpper;
                        
                        // Match with .N0000 suffix (common format in your data)
                        const suffixMatch = holdingSymbolUpper === searchSymbolUpper + '0000';
                        
                        // Match without .N0000 suffix
                        const prefixMatch = holdingSymbolUpper === searchSymbolUpper.replace(/0000$/, '');
                        
                        const matches = directMatch || suffixMatch || prefixMatch;
                        return matches;
                    });
                    
                    if (holding) {
                        return {
                            quantity: parseFloat(holding.quantity) || 0,
                            avgPrice: parseFloat(holding.avgPrice || holding.avgCost) || 0,
                            symbol: holding.symbol || holding.security,
                            portfolioName: portfolio.name || 'Portfolio'
                        };
                    }
                }
            }
            
            return null;
        }

        function autoFillFromPortfolio(symbol) {
            if (!symbol) return;
            
            const stockData = findStockInPortfolio(symbol);
            
            if (stockData && stockData.quantity > 0 && stockData.avgPrice > 0) {
                document.getElementById('currentQuantity').value = stockData.quantity;
                document.getElementById('currentAvgPrice').value = stockData.avgPrice;
                
                // Show success message briefly
                showAutoFillMessage(`Auto-filled: ${formatNumber(stockData.quantity, 0)} shares at Rs. ${formatNumber(stockData.avgPrice)}`, 'success');
                
                // Trigger calculation
                autoCalculateAvgPrice();
            } else {
                showAutoFillMessage(`Stock "${symbol}" not found in portfolio`, 'error');
            }
        }

        function showAutoFillMessage(message, type) {
            // Remove any existing message
            const existingMessage = document.getElementById('autoFillMessage');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // Create new message
            const messageDiv = document.createElement('div');
            messageDiv.id = 'autoFillMessage';
            messageDiv.className = `mt-2 p-2 rounded-lg text-sm ${
                type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
            }`;
            messageDiv.textContent = message;
            
            // Insert after the current holdings section
            const currentHoldingsDiv = document.querySelector('.bg-gray-50.rounded-lg.p-4');
            currentHoldingsDiv.parentNode.insertBefore(messageDiv, currentHoldingsDiv.nextSibling);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // Average Price Calculator Functions
        let currentAvgPriceMode = 'calculate'; // 'calculate' or 'quantity'

        function switchAvgPriceMode(mode) {
            currentAvgPriceMode = mode;
            
            // Update button styles
            const avgPriceBtn = document.getElementById('avgPriceModeBtn');
            const quantityBtn = document.getElementById('quantityModeBtn');
            
            if (mode === 'calculate') {
                avgPriceBtn.className = 'flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors bg-white text-green-600 shadow-sm';
                quantityBtn.className = 'flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900';
                
                // Show/hide sections
                document.getElementById('calculateMode').classList.remove('hidden');
                document.getElementById('quantityMode').classList.add('hidden');
            } else {
                avgPriceBtn.className = 'flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900';
                quantityBtn.className = 'flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors bg-white text-blue-600 shadow-sm';
                
                // Show/hide sections
                document.getElementById('calculateMode').classList.add('hidden');
                document.getElementById('quantityMode').classList.remove('hidden');
            }
            
            // Clear results and recalculate
            document.getElementById('avgPriceResults').classList.add('hidden');
            autoCalculateAvgPrice();
        }

        function calculateRequiredQuantity(symbol, currentQty, currentAvgPrice, targetAvgPrice, marketPrice) {
            if (currentQty <= 0 || currentAvgPrice <= 0 || targetAvgPrice <= 0 || marketPrice <= 0) {
                return null;
            }

            // Calculate brokerage per share (1.12% of market price)
            const brokeragePerShare = marketPrice * 0.0112;
            const effectiveMarketPrice = marketPrice + brokeragePerShare;

            // Check if target is impossible - target must be lower than current average to be achievable by buying
            if (targetAvgPrice >= currentAvgPrice) {
                return {
                    error: 'IMPOSSIBLE_TARGET',
                    message: `Cannot achieve target average of Rs. ${formatNumber(targetAvgPrice)}. Current average (Rs. ${formatNumber(currentAvgPrice)}) is already lower than or equal to target. You can only lower your average by buying at a lower price.`
                };
            }

            // Formula: Required Qty = (Current Qty × (Target Avg - Current Avg)) ÷ (Market Price + Fees - Target Avg)
            const numerator = currentQty * (targetAvgPrice - currentAvgPrice);
            const denominator = effectiveMarketPrice - targetAvgPrice;
            
            // Check if denominator is zero (mathematically impossible)
            if (denominator === 0) {
                return {
                    error: 'IMPOSSIBLE_TARGET',
                    message: `Cannot achieve target average of Rs. ${formatNumber(targetAvgPrice)}. Market price + brokerage equals target price.`
                };
            }
            
            const requiredQty = numerator / denominator;
            
            // Check if result is negative (impossible scenario)
            if (requiredQty < 0) {
                return {
                    error: 'IMPOSSIBLE_TARGET',
                    message: `Cannot achieve target average of Rs. ${formatNumber(targetAvgPrice)}. Current average (Rs. ${formatNumber(currentAvgPrice)}) is already lower than target.`
                };
            }
            
            return {
                symbol: symbol,
                currentQty: currentQty,
                currentAvgPrice: currentAvgPrice,
                targetAvgPrice: targetAvgPrice,
                marketPrice: marketPrice,
                brokeragePerShare: brokeragePerShare,
                effectiveMarketPrice: effectiveMarketPrice,
                requiredQty: Math.ceil(requiredQty), // Round up to whole shares
                totalCost: Math.ceil(requiredQty) * effectiveMarketPrice,
                newTotalQty: currentQty + Math.ceil(requiredQty),
                newAvgPrice: targetAvgPrice
            };
        }

        function autoCalculateAvgPrice() {
            const symbol = document.getElementById('avgStockSymbol').value.trim();
            const currentQty = parseInt(document.getElementById('currentQuantity').value) || 0;
            const currentPrice = parseFloat(document.getElementById('currentAvgPrice').value) || 0;

            if (currentAvgPriceMode === 'calculate') {
                // Mode 1: Calculate new average price
                const newQty = parseInt(document.getElementById('newQuantity').value) || 0;
                const newPrice = parseFloat(document.getElementById('newPrice').value) || 0;

                // Check if all required fields are filled
                if (symbol && currentQty > 0 && currentPrice > 0 && newQty > 0 && newPrice > 0) {
                    // Calculate results
                    currentAvgPriceCalculation = calculateAvgPriceResults(symbol, currentQty, currentPrice, newQty, newPrice);

                    // Display results
                    displayAvgPriceResults(currentAvgPriceCalculation);

                    // Show save button
                    document.getElementById('avgPriceSaveButtonContainer').classList.remove('hidden');
                } else {
                    // Hide results if not all required fields are filled
                    document.getElementById('avgPriceResults').classList.add('hidden');
                    document.getElementById('avgPriceSaveButtonContainer').classList.add('hidden');
                    currentAvgPriceCalculation = null;
                }
            } else {
                // Mode 2: Calculate required quantity
                const targetAvgPrice = parseFloat(document.getElementById('targetAvgPrice').value) || 0;
                const marketPrice = parseFloat(document.getElementById('currentMarketPrice').value) || 0;

                // Check if all required fields are filled
                if (symbol && currentQty > 0 && currentPrice > 0 && targetAvgPrice > 0 && marketPrice > 0) {
                    // Calculate results
                    currentAvgPriceCalculation = calculateRequiredQuantity(symbol, currentQty, currentPrice, targetAvgPrice, marketPrice);

                    if (currentAvgPriceCalculation) {
                        if (currentAvgPriceCalculation.error) {
                            // Display error message
                            displayQuantityError(currentAvgPriceCalculation);
                        } else {
                            // Display results
                            displayQuantityResults(currentAvgPriceCalculation);
                        }

                        // Show save button
                        document.getElementById('avgPriceSaveButtonContainer').classList.remove('hidden');
                    } else {
                        // Hide results if calculation failed
                        document.getElementById('avgPriceResults').classList.add('hidden');
                        document.getElementById('avgPriceSaveButtonContainer').classList.add('hidden');
                        currentAvgPriceCalculation = null;
                    }
                } else {
                    // Hide results if not all required fields are filled
                    document.getElementById('avgPriceResults').classList.add('hidden');
                    document.getElementById('avgPriceSaveButtonContainer').classList.add('hidden');
                    currentAvgPriceCalculation = null;
                }
            }
        }

        function calculateAvgPriceResults(symbol, currentQty, currentPrice, newQty, newPrice) {
            const totalQty = currentQty + newQty;
            const currentValue = currentQty * currentPrice;
            const newValue = newQty * newPrice;
            const brokerageFees = newValue * 0.0112; // 1.12% brokerage
            const totalValue = currentValue + newValue + brokerageFees;
            const newAvgPrice = totalValue / totalQty;

            // Calculate change in average price
            const priceChange = newAvgPrice - currentPrice;
            const priceChangePercent = (priceChange / currentPrice) * 100;

            return {
                id: Date.now().toString(),
                timestamp: new Date().toISOString(),
                symbol,
                currentQty,
                currentPrice,
                newQty,
                newPrice,
                brokerageFees,
                totalQty,
                currentValue,
                newValue,
                totalValue,
                newAvgPrice,
                priceChange,
                priceChangePercent
            };
        }

        function displayAvgPriceResults(results) {
            const resultsDiv = document.getElementById('avgPriceResults');
            const contentDiv = document.getElementById('avgPriceContent');

            const changeClass = results.priceChange >= 0 ? 'profit-text' : 'loss-text';
            const changeIcon = results.priceChange >= 0 ? '↗' : '↘';

            contentDiv.innerHTML = `
                <div class="space-y-4">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-gray-900 mb-2">
                            Rs. ${formatNumber(results.newAvgPrice)}
                        </div>
                        <div class="text-lg text-gray-600">New Average Price</div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="text-center">
                            <div class="text-gray-600">Total Quantity</div>
                            <div class="font-semibold text-gray-900">${formatNumber(results.totalQty, 0)}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-gray-600">Total Value</div>
                            <div class="font-semibold text-gray-900">Rs. ${formatNumber(results.totalValue)}</div>
                        </div>
                    </div>
                    
                    ${results.brokerageFees > 0 ? `
                    <div class="text-center text-sm">
                        <div class="text-gray-600">Including 1.12% Brokerage</div>
                        <div class="font-semibold text-gray-900">Rs. ${formatNumber(results.brokerageFees)}</div>
                    </div>
                    ` : ''}
                    
                    <div class="text-center">
                        <div class="text-lg ${changeClass} font-semibold">
                            ${changeIcon} ${results.priceChange >= 0 ? '+' : ''}Rs. ${formatNumber(Math.abs(results.priceChange))}
                        </div>
                        <div class="text-sm ${changeClass}">
                            ${results.priceChange >= 0 ? '+' : ''}${formatNumber(results.priceChangePercent)}% change
                        </div>
                    </div>
                </div>
            `;

            resultsDiv.classList.remove('hidden');
        }

        function displayQuantityError(errorResult) {
            const resultsDiv = document.getElementById('avgPriceResults');
            const contentDiv = document.getElementById('avgPriceContent');

            contentDiv.innerHTML = `
                <div class="text-center">
                    <div class="text-3xl font-bold text-red-600 mb-2">
                        ⚠️
                    </div>
                    <div class="text-lg text-red-600 font-semibold mb-2">Impossible Target</div>
                    <div class="text-sm text-red-700 bg-red-50 rounded-lg p-3">
                        ${errorResult.message}
                    </div>
                </div>
            `;

            resultsDiv.classList.remove('hidden');
        }

        function displayQuantityResults(results) {
            const resultsDiv = document.getElementById('avgPriceResults');
            const contentDiv = document.getElementById('avgPriceContent');

            contentDiv.innerHTML = `
                <div class="space-y-4">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-blue-600 mb-2">
                            ${formatNumber(results.requiredQty, 0)}
                        </div>
                        <div class="text-lg text-gray-600">Shares to Buy</div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="text-center">
                            <div class="text-gray-600">Total Cost</div>
                            <div class="font-semibold text-gray-900">Rs. ${formatNumber(results.totalCost)}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-gray-600">New Total Qty</div>
                            <div class="font-semibold text-gray-900">${formatNumber(results.newTotalQty, 0)}</div>
                        </div>
                    </div>
                    
                    ${results.brokeragePerShare > 0 ? `
                    <div class="text-center text-sm">
                        <div class="text-gray-600">Effective Price per Share</div>
                        <div class="font-semibold text-gray-900">Rs. ${formatNumber(results.effectiveMarketPrice)} (Market: Rs. ${formatNumber(results.marketPrice)} + Rs. ${formatNumber(results.brokeragePerShare)} brokerage)</div>
                    </div>
                    ` : ''}
                    
                    <div class="text-center">
                        <div class="text-lg text-green-600 font-semibold">
                            Target Avg: Rs. ${formatNumber(results.newAvgPrice)}
                        </div>
                        <div class="text-sm text-gray-600">
                            Market Price: Rs. ${formatNumber(results.marketPrice)}
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 rounded-lg p-3 text-sm">
                        <div class="text-blue-800 font-medium mb-1">Current Position:</div>
                        <div class="text-blue-700">
                            ${formatNumber(results.currentQty, 0)} shares @ Rs. ${formatNumber(results.currentAvgPrice)}
                        </div>
                    </div>
                </div>
            `;

            resultsDiv.classList.remove('hidden');
        }

        function saveAvgPriceToTable() {
            if (!currentAvgPriceCalculation) {
                alert('Please calculate first before saving');
                return;
            }

            // Save to localStorage
            const savedCalculations = JSON.parse(localStorage.getItem('avgPriceCalculations') || '[]');
            savedCalculations.unshift(currentAvgPriceCalculation);
            localStorage.setItem('avgPriceCalculations', JSON.stringify(savedCalculations));

            // Refresh the table
            loadSavedCalculations();

            // Hide results and clear form
            document.getElementById('avgPriceResults').classList.add('hidden');
            clearAvgPriceForm();
            currentAvgPriceCalculation = null;
        }

        function clearAvgPriceForm() {
            document.getElementById('avgStockSymbol').value = '';
            document.getElementById('currentQuantity').value = '';
            document.getElementById('currentAvgPrice').value = '';
            document.getElementById('newQuantity').value = '';
            document.getElementById('newPrice').value = '';
            autoCalculateAvgPrice();
        }

        function clearAvgPriceAll() {
            document.getElementById('avgStockSymbol').value = '';
            document.getElementById('currentQuantity').value = '';
            document.getElementById('currentAvgPrice').value = '';
            document.getElementById('newQuantity').value = '';
            document.getElementById('newPrice').value = '';
            document.getElementById('targetAvgPrice').value = '';
            document.getElementById('currentMarketPrice').value = '';
            document.getElementById('avgPriceResults').classList.add('hidden');
            document.getElementById('avgPriceSaveButtonContainer').classList.add('hidden');
            currentAvgPriceCalculation = null;
        }

        // Autocomplete functionality
        function showSuggestions(input, suggestions) {
            const suggestionsDiv = document.getElementById('symbolSuggestions');

            if (suggestions.length === 0) {
                suggestionsDiv.classList.add('hidden');
                return;
            }

            suggestionsDiv.innerHTML = suggestions.map(symbol =>
                `<div class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm" onclick="selectSymbol('${symbol}')">${symbol}</div>`
            ).join('');

            suggestionsDiv.classList.remove('hidden');
        }

        function selectSymbol(symbol) {
            document.getElementById('stockSymbol').value = symbol;
            document.getElementById('symbolSuggestions').classList.add('hidden');
            autoCalculate();
        }

        function showAvgSuggestions(input, suggestions) {
            const suggestionsDiv = document.getElementById('avgSymbolSuggestions');

            if (suggestions.length === 0) {
                suggestionsDiv.classList.add('hidden');
                return;
            }

            suggestionsDiv.innerHTML = suggestions.map(symbol =>
                `<div class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm" onclick="selectAvgSymbol('${symbol}')">${symbol}</div>`
            ).join('');

            suggestionsDiv.classList.remove('hidden');
        }

        function selectAvgSymbol(symbol) {
            document.getElementById('avgStockSymbol').value = symbol;
            document.getElementById('avgSymbolSuggestions').classList.add('hidden');
            
            // Auto-fill from portfolio
            autoFillFromPortfolio(symbol);
            
            autoCalculateAvgPrice();
        }

        function filterSymbols(input) {
            if (input.length < 1) {
                return [];
            }

            return STOCK_SYMBOLS.filter(symbol =>
                symbol.toLowerCase().includes(input.toLowerCase())
            ).slice(0, 10); // Limit to 10 suggestions
        }

        // Auto-calculate function
        function autoCalculate() {
            const symbol = document.getElementById('stockSymbol').value.trim();
            const quantity = parseInt(document.getElementById('quantity').value) || 0;
            const buyPrice = parseFloat(document.getElementById('buyPrice').value) || 0;
            const sellPrice = parseFloat(document.getElementById('sellPrice').value) || 0;
            const useAvgPrice = document.getElementById('useAvgPrice').checked;

            // Check if all required fields are filled
            if (symbol && quantity > 0 && buyPrice > 0) {
                // Calculate results
                currentCalculation = calculateResults(symbol, quantity, buyPrice, sellPrice, useAvgPrice);

                // Display results
                displayResults(currentCalculation);

                // Show save button if all fields are complete
                if (sellPrice > 0) {
                    document.getElementById('saveButtonContainer').classList.remove('hidden');
                } else {
                    document.getElementById('saveButtonContainer').classList.add('hidden');
                }
            } else {
                // Hide results if not all required fields are filled
                document.getElementById('calculationResults').classList.add('hidden');
                document.getElementById('saveButtonContainer').classList.add('hidden');
                currentCalculation = null;
            }
        }

        // Display calculation results
        function displayResults(results) {
            const resultsDiv = document.getElementById('calculationResults');
            const contentDiv = document.getElementById('resultsContent');

            const profitClass = results.profit >= 0 ? 'profit-text' : 'loss-text';
            const profitIcon = results.profit >= 0 ? '↗' : '↘';

            if (results.sellPrice > 0) {
                contentDiv.innerHTML = `
                    <div class="space-y-2">
                        <div class="text-2xl font-bold ${profitClass}">
                            ${profitIcon} ${results.profit >= 0 ? '+' : ''}Rs. ${formatNumber(Math.abs(results.profit))}
                        </div>
                        <div class="text-lg ${profitClass} font-semibold">
                            ${results.profit >= 0 ? '+' : ''}${formatNumber(results.profitPercent)}%
                        </div>
                    </div>
                `;
            } else {
                contentDiv.innerHTML = `
                    <div class="space-y-2">
                        <div class="text-lg text-gray-600">Buy Cost: Rs. ${formatNumber(results.buyCost)}</div>
                        <div class="text-sm text-gray-500">
                            Enter sell price to see P&L
                        </div>
                    </div>
                `;
            }

            resultsDiv.classList.remove('hidden');
        }

        // Save current calculation to table
        function saveToTable() {
            if (!currentCalculation) {
                alert('Please calculate first before saving');
                return;
            }

            // Save to localStorage
            const savedCalculations = JSON.parse(localStorage.getItem('stockCalculations') || '[]');
            savedCalculations.unshift(currentCalculation);
            localStorage.setItem('stockCalculations', JSON.stringify(savedCalculations));

            // Refresh the table
            loadSavedCalculations();

            // Hide results and clear form
            document.getElementById('calculationResults').classList.add('hidden');
            clearForm();
            currentCalculation = null;
        }

        // Calculate all results
        function calculateResults(symbol, quantity, buyPrice, sellPrice, useAvgPrice) {
            // Calculate buy cost
            let buyCost;
            let buyBrokerage;

            if (useAvgPrice) {
                // Average price already includes brokerage, so buyCost is just the gross value
                buyCost = buyPrice * quantity;
                buyBrokerage = 0;
            } else {
                // Regular buy with brokerage
                const buyGrossValue = buyPrice * quantity;
                buyBrokerage = buyGrossValue * BROKERAGE_PERCENTAGE;
                buyCost = buyGrossValue + buyBrokerage;
            }

            let sellBrokerage = 0;
            let sellValue = 0;
            let profit = 0;
            let profitPercent = 0;

            if (sellPrice > 0) {
                const sellGrossValue = sellPrice * quantity;
                sellBrokerage = sellGrossValue * BROKERAGE_PERCENTAGE; // Always apply brokerage to sell
                sellValue = sellGrossValue - sellBrokerage;
                profit = sellValue - buyCost;
                profitPercent = (profit / buyCost) * 100;
            }

            return {
                id: Date.now().toString(),
                timestamp: new Date().toISOString(),
                symbol,
                quantity,
                buyPrice,
                sellPrice,
                buyBrokerage,
                buyCost,
                sellBrokerage,
                sellValue,
                profit,
                profitPercent,
                useAvgPrice
            };
        }


        // Clear form after saving
        function clearForm() {
            document.getElementById('stockSymbol').value = '';
            document.getElementById('quantity').value = '';
            document.getElementById('buyPrice').value = '';
            document.getElementById('sellPrice').value = '';
            document.getElementById('useAvgPrice').checked = false;
            updateBrokerageInfo();
            autoCalculate();
        }

        // Utility functions
        function clearAll() {
            document.getElementById('stockSymbol').value = '';
            document.getElementById('quantity').value = '';
            document.getElementById('buyPrice').value = '';
            document.getElementById('sellPrice').value = '';
            document.getElementById('useAvgPrice').checked = false;
            document.getElementById('calculationResults').classList.add('hidden');
            document.getElementById('saveButtonContainer').classList.add('hidden');
            currentCalculation = null;
            updateBrokerageInfo();
        }

        // Sorting functionality
        let sortDirection = {};

        function sortTable(columnIndex) {
            const table = document.getElementById('calculationsTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            // Toggle sort direction
            sortDirection[columnIndex] = sortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';
            const isAsc = sortDirection[columnIndex] === 'asc';

            rows.sort((a, b) => {
                let aVal, bVal;

                if (columnIndex === 0) { // Symbol column
                    aVal = a.cells[0].textContent.trim();
                    bVal = b.cells[0].textContent.trim();
                } else {
                    aVal = parseFloat(a.cells[columnIndex].getAttribute('data-sort')) || 0;
                    bVal = parseFloat(b.cells[columnIndex].getAttribute('data-sort')) || 0;
                }

                if (aVal < bVal) return isAsc ? -1 : 1;
                if (aVal > bVal) return isAsc ? 1 : -1;
                return 0;
            });

            // Clear tbody and append sorted rows
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));

            // Update header arrows
            const headers = table.querySelectorAll('th');
            headers.forEach((header, index) => {
                const sortIcon = header.querySelector('.sort-icon');
                if (index === columnIndex) {
                    sortIcon.textContent = isAsc ? '↑' : '↓';
                } else {
                    sortIcon.textContent = '⇅';
                }
            });
        }

        // Update summary statistics
        function updateSummaryStats(calculations) {
            const completedCalculations = calculations.filter(calc => calc.sellPrice > 0);

            if (completedCalculations.length === 0) {
                document.getElementById('totalPnL').textContent = 'Rs. 0.00';
                document.getElementById('avgReturn').textContent = '0.00%';
                return;
            }

            const totalPnL = completedCalculations.reduce((sum, calc) => sum + (calc.profit || 0), 0);
            const avgReturn = completedCalculations.reduce((sum, calc) => sum + (calc.profitPercent || 0), 0) / completedCalculations.length;

            const totalPnLClass = totalPnL >= 0 ? 'profit-text' : 'loss-text';
            const avgReturnClass = avgReturn >= 0 ? 'profit-text' : 'loss-text';

            document.getElementById('totalPnL').textContent = `${totalPnL >= 0 ? '+' : ''}Rs. ${formatNumber(Math.abs(totalPnL))}`;
            document.getElementById('totalPnL').className = `text-lg font-semibold ${totalPnLClass}`;

            document.getElementById('avgReturn').textContent = `${avgReturn >= 0 ? '+' : ''}${formatNumber(avgReturn)}%`;
            document.getElementById('avgReturn').className = `text-lg font-semibold ${avgReturnClass}`;
        }

        // Export to JSON
        function exportToJSON() {
            const buySellCalculations = JSON.parse(localStorage.getItem('stockCalculations') || '[]');
            const avgPriceCalculations = JSON.parse(localStorage.getItem('avgPriceCalculations') || '[]');
            const allCalculations = {
                buySellCalculations,
                avgPriceCalculations,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            const dataStr = JSON.stringify(allCalculations, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });

            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `calculator-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        // Import from JSON
        function importFromJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        try {
                            const importedData = JSON.parse(e.target.result);

                            if (importedData.buySellCalculations && importedData.avgPriceCalculations) {
                                // New format with both calculation types
                                const existingBuySell = JSON.parse(localStorage.getItem('stockCalculations') || '[]');
                                const existingAvgPrice = JSON.parse(localStorage.getItem('avgPriceCalculations') || '[]');

                                const mergedBuySell = [...existingBuySell, ...importedData.buySellCalculations];
                                const mergedAvgPrice = [...existingAvgPrice, ...importedData.avgPriceCalculations];

                                localStorage.setItem('stockCalculations', JSON.stringify(mergedBuySell));
                                localStorage.setItem('avgPriceCalculations', JSON.stringify(mergedAvgPrice));

                                loadSavedCalculations();
                                alert(`Successfully imported ${importedData.buySellCalculations.length} buy/sell calculations and ${importedData.avgPriceCalculations.length} average price calculations!`);
                            } else if (Array.isArray(importedData)) {
                                // Legacy format - assume all are buy/sell calculations
                                const existingCalculations = JSON.parse(localStorage.getItem('stockCalculations') || '[]');
                                const mergedCalculations = [...existingCalculations, ...importedData];
                                localStorage.setItem('stockCalculations', JSON.stringify(mergedCalculations));
                                loadSavedCalculations();
                                alert(`Successfully imported ${importedData.length} buy/sell calculations!`);
                            } else {
                                alert('Invalid JSON format. Please select a valid calculations file.');
                            }
                        } catch (error) {
                            alert('Error reading file. Please make sure it\'s a valid JSON file.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Load saved calculations
        function loadSavedCalculations() {
            const buySellCalculations = JSON.parse(localStorage.getItem('stockCalculations') || '[]');
            const avgPriceCalculations = JSON.parse(localStorage.getItem('avgPriceCalculations') || '[]');
            const allCalculations = [...buySellCalculations, ...avgPriceCalculations];

            // Sort by timestamp (newest first)
            allCalculations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const tableDiv = document.getElementById('savedCalculationsTable');
            const summaryStats = document.getElementById('summaryStats');

            if (allCalculations.length === 0) {
                tableDiv.innerHTML = '<div class="text-center text-gray-500 py-8">No saved calculations yet</div>';
                summaryStats.classList.add('hidden');
                return;
            }

            // Show summary stats
            summaryStats.classList.remove('hidden');
            updateSummaryStats(buySellCalculations); // Only show P&L stats for buy/sell calculations

            tableDiv.innerHTML = `
                <div class="overflow-x-auto">
                    <table id="calculationsTable" class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-200 bg-gray-50">
                                <th class="text-left py-3 px-4 font-semibold text-gray-700 cursor-pointer hover:bg-gray-100" onclick="sortTable(0)">
                                    Symbol <span class="sort-icon">⇅</span>
                                </th>
                                <th class="text-center py-3 px-4 font-semibold text-gray-700 cursor-pointer hover:bg-gray-100" onclick="sortTable(1)">
                                    Type <span class="sort-icon">⇅</span>
                                </th>
                                <th class="text-right py-3 px-4 font-semibold text-gray-700 cursor-pointer hover:bg-gray-100" onclick="sortTable(2)">
                                    Qty <span class="sort-icon">⇅</span>
                                </th>
                                <th class="text-right py-3 px-4 font-semibold text-gray-700 cursor-pointer hover:bg-gray-100" onclick="sortTable(3)">
                                    Price <span class="sort-icon">⇅</span>
                                </th>
                                <th class="text-right py-3 px-4 font-semibold text-gray-700 cursor-pointer hover:bg-gray-100" onclick="sortTable(4)">
                                    Value/Result <span class="sort-icon">⇅</span>
                                </th>
                                <th class="text-right py-3 px-4 font-semibold text-gray-700 cursor-pointer hover:bg-gray-100" onclick="sortTable(5)">
                                    Additional Info <span class="sort-icon">⇅</span>
                                </th>
                                <th class="text-center py-3 px-4 font-semibold text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allCalculations.map(calc => {
                // Check if it's a buy/sell calculation or avg price calculation
                if (calc.profit !== undefined) {
                    // Buy/Sell calculation
                    const profitClass = calc.profit >= 0 ? 'profit-text' : 'loss-text';
                    const profitLabel = calc.profit >= 0 ? '+' : '';
                    const returnLabel = calc.profit >= 0 ? '+' : '';
                    const buyType = calc.useAvgPrice ? 'Avg' : 'Buy';

                    return `
                                        <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                                            <td class="py-3 px-4 font-semibold text-gray-900">${calc.symbol}</td>
                                            <td class="py-3 px-4 text-center">
                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                    Buy/Sell
                                                </span>
                                            </td>
                                            <td class="py-3 px-4 text-right text-gray-600" data-sort="${calc.quantity}">${formatNumber(calc.quantity, 0)}</td>
                                            <td class="py-3 px-4 text-right text-gray-600" data-sort="${calc.buyPrice}">
                                                <div class="flex items-center justify-end space-x-2">
                                                    <span>Rs. ${formatNumber(calc.buyPrice)}</span>
                                                    <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium ${calc.useAvgPrice ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                                        ${buyType}
                                                    </span>
                                                </div>
                                            </td>
                                            <td class="py-3 px-4 text-right text-gray-600" data-sort="${calc.buyCost}">Rs. ${formatNumber(calc.buyCost)}</td>
                                            <td class="py-3 px-4 text-right text-gray-600" data-sort="${calc.sellPrice || 0}">${calc.sellPrice > 0 ? `Rs. ${formatNumber(calc.sellPrice)}` : '-'}</td>
                                            <td class="py-3 px-4 text-center">
                                                <div class="flex justify-center space-x-1">
                                                    <button onclick="loadCalculation('${calc.id}')" class="text-blue-600 hover:text-blue-700 p-1.5 rounded hover:bg-blue-50 transition-colors" title="Load calculation">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                                        </svg>
                                                    </button>
                                                    <button onclick="deleteCalculation('${calc.id}')" class="text-red-600 hover:text-red-700 p-1.5 rounded hover:bg-red-50 transition-colors" title="Delete calculation">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                } else {
                    // Average Price calculation
                    const changeClass = calc.priceChange >= 0 ? 'profit-text' : 'loss-text';
                    const changeLabel = calc.priceChange >= 0 ? '+' : '';

                    return `
                                        <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                                            <td class="py-3 px-4 font-semibold text-gray-900">${calc.symbol}</td>
                                            <td class="py-3 px-4 text-center">
                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                    Avg Price
                                                </span>
                                            </td>
                                            <td class="py-3 px-4 text-right text-gray-600" data-sort="${calc.totalQty}">${formatNumber(calc.totalQty, 0)}</td>
                                            <td class="py-3 px-4 text-right text-gray-600" data-sort="${calc.newAvgPrice}">Rs. ${formatNumber(calc.newAvgPrice)}</td>
                                            <td class="py-3 px-4 text-right text-gray-600" data-sort="${calc.totalValue}">Rs. ${formatNumber(calc.totalValue)}</td>
                                            <td class="py-3 px-4 text-right ${changeClass} font-semibold" data-sort="${calc.priceChange}">
                                                ${changeLabel}Rs. ${formatNumber(Math.abs(calc.priceChange))}
                                            </td>
                                            <td class="py-3 px-4 text-center">
                                                <div class="flex justify-center space-x-1">
                                                    <button onclick="loadAvgPriceCalculation('${calc.id}')" class="text-green-600 hover:text-green-700 p-1.5 rounded hover:bg-green-50 transition-colors" title="Load calculation">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                                        </svg>
                                                    </button>
                                                    <button onclick="deleteAvgPriceCalculation('${calc.id}')" class="text-red-600 hover:text-red-700 p-1.5 rounded hover:bg-red-50 transition-colors" title="Delete calculation">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                }
            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Load a saved calculation
        function loadCalculation(id) {
            const savedCalculations = JSON.parse(localStorage.getItem('stockCalculations') || '[]');
            const calc = savedCalculations.find(c => c.id === id);

            if (calc) {
                document.getElementById('stockSymbol').value = calc.symbol;
                document.getElementById('quantity').value = calc.quantity || '';
                document.getElementById('buyPrice').value = calc.buyPrice;
                document.getElementById('sellPrice').value = calc.sellPrice || '';
                document.getElementById('useAvgPrice').checked = calc.useAvgPrice || false;

                updateBrokerageInfo();
                autoCalculate();
            }
        }

        // Delete a saved calculation
        function deleteCalculation(id) {
            if (confirm('Are you sure you want to delete this calculation?')) {
                const savedCalculations = JSON.parse(localStorage.getItem('stockCalculations') || '[]');
                const filtered = savedCalculations.filter(c => c.id !== id);
                localStorage.setItem('stockCalculations', JSON.stringify(filtered));
                loadSavedCalculations();
            }
        }

        // Load a saved average price calculation
        function loadAvgPriceCalculation(id) {
            const savedCalculations = JSON.parse(localStorage.getItem('avgPriceCalculations') || '[]');
            const calc = savedCalculations.find(c => c.id === id);

            if (calc) {
                // Switch to average price tab
                switchTab('avgPrice');

                document.getElementById('avgStockSymbol').value = calc.symbol;
                document.getElementById('currentQuantity').value = calc.currentQty || '';
                document.getElementById('currentAvgPrice').value = calc.currentPrice;
                document.getElementById('newQuantity').value = calc.newQty || '';
                document.getElementById('newPrice').value = calc.newPrice;

                autoCalculateAvgPrice();
            }
        }

        // Delete a saved average price calculation
        function deleteAvgPriceCalculation(id) {
            if (confirm('Are you sure you want to delete this calculation?')) {
                const savedCalculations = JSON.parse(localStorage.getItem('avgPriceCalculations') || '[]');
                const filtered = savedCalculations.filter(c => c.id !== id);
                localStorage.setItem('avgPriceCalculations', JSON.stringify(filtered));
                loadSavedCalculations();
            }
        }

        // Clear all saved calculations
        function clearSavedCalculations() {
            if (confirm('Are you sure you want to clear all saved calculations?')) {
                localStorage.removeItem('stockCalculations');
                localStorage.removeItem('avgPriceCalculations');
                loadSavedCalculations();
            }
        }

        // Update brokerage info based on toggle
        function updateBrokerageInfo() {
            const useAvgPrice = document.getElementById('useAvgPrice').checked;
            const infoElement = document.getElementById('brokerageInfo');

            if (useAvgPrice) {
                infoElement.textContent = 'No brokerage fee for buy (Average Price), 1.12% for sell';
            } else {
                infoElement.textContent = '1.12% brokerage fee for buy and sell transactions';
            }
        }

        function goBack() {
            window.location.href = 'index.html';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            // Ensure Font Awesome icons are loaded
            setTimeout(function () {
                const icons = document.querySelectorAll('.fas, .far, .fab');
                icons.forEach(function (icon) {
                    if (!icon.style.fontFamily || icon.style.fontFamily.indexOf('Font Awesome') === -1) {
                        icon.style.fontFamily = '"Font Awesome 6 Free", "Font Awesome 6 Pro", "Font Awesome 5 Free", "Font Awesome 5 Pro", "FontAwesome"';
                        icon.style.fontWeight = '900';
                    }
                });
            }, 100);

            // Mobile Menu Toggle
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenuBtn && mobileMenu) {
                mobileMenuBtn.addEventListener('click', function () {
                    mobileMenu.classList.toggle('hidden');
                });
            }

            // Handle average price toggle
            document.getElementById('useAvgPrice').addEventListener('change', function () {
                updateBrokerageInfo();
                autoCalculate();
            });

            // Auto-calculate on input changes
            const inputs = ['quantity', 'buyPrice', 'sellPrice'];
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', autoCalculate);
                    input.addEventListener('change', autoCalculate);
                }
            });

            // Add dynamic step adjustment for price fields
            const priceFields = ['buyPrice', 'sellPrice', 'newPrice', 'currentMarketPrice'];
            priceFields.forEach(fieldId => {
                const input = document.getElementById(fieldId);
                if (input) {
                    input.addEventListener('input', function() {
                        adjustPriceStep(this);
                    });
                    input.addEventListener('change', function() {
                        adjustPriceStep(this);
                    });
                }
            });

            // Auto-calculate average price on input changes
            const avgPriceInputs = ['currentQuantity', 'currentAvgPrice', 'newQuantity', 'newPrice'];
            avgPriceInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', autoCalculateAvgPrice);
                    input.addEventListener('change', autoCalculateAvgPrice);
                }
            });

            // Stock symbol autocomplete
            const stockSymbolInput = document.getElementById('stockSymbol');
            if (stockSymbolInput) {
                stockSymbolInput.addEventListener('input', function (e) {
                    const input = e.target.value.trim();
                    const suggestions = filterSymbols(input);
                    showSuggestions(input, suggestions);
                    autoCalculate();
                });

                stockSymbolInput.addEventListener('blur', function () {
                    // Hide suggestions after a short delay to allow clicking
                    setTimeout(() => {
                        document.getElementById('symbolSuggestions').classList.add('hidden');
                    }, 200);
                });

                stockSymbolInput.addEventListener('focus', function () {
                    const input = this.value.trim();
                    if (input.length > 0) {
                        const suggestions = filterSymbols(input);
                        showSuggestions(input, suggestions);
                    }
                });
            }

            // Average price symbol autocomplete
            const avgStockSymbolInput = document.getElementById('avgStockSymbol');
            if (avgStockSymbolInput) {
                avgStockSymbolInput.addEventListener('input', function (e) {
                    const input = e.target.value.trim();
                    const suggestions = filterSymbols(input);
                    showAvgSuggestions(input, suggestions);
                    
                    // Clear previous timeout
                    if (autoFillTimeout) {
                        clearTimeout(autoFillTimeout);
                    }
                    
                    // Auto-fill from portfolio if symbol is complete (no spaces, looks like a valid symbol)
                    if (input.length >= 3 && !input.includes(' ')) {
                        autoFillTimeout = setTimeout(() => {
                            autoFillFromPortfolio(input);
                        }, 500); // Wait 500ms after user stops typing
                    }
                    
                    autoCalculateAvgPrice();
                });

                avgStockSymbolInput.addEventListener('blur', function () {
                    // Hide suggestions after a short delay to allow clicking
                    setTimeout(() => {
                        document.getElementById('avgSymbolSuggestions').classList.add('hidden');
                    }, 200);
                });

                avgStockSymbolInput.addEventListener('focus', function () {
                    const input = this.value.trim();
                    if (input.length > 0) {
                        const suggestions = filterSymbols(input);
                        showAvgSuggestions(input, suggestions);
                    }
                });
            }

            // Add event listeners for new input fields
            const targetAvgPriceInput = document.getElementById('targetAvgPrice');
            const currentMarketPriceInput = document.getElementById('currentMarketPrice');
            
            if (targetAvgPriceInput) {
                targetAvgPriceInput.addEventListener('input', autoCalculateAvgPrice);
            }
            
            if (currentMarketPriceInput) {
                currentMarketPriceInput.addEventListener('input', autoCalculateAvgPrice);
            }

            // Load saved calculations on page load
            loadSavedCalculations();
        });
    </script>

    <!-- Footer -->
    <footer class="bg-white border-t mt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <!-- Brand Section -->
                <div class="col-span-1 md:col-span-2">
                    <div class="flex items-center space-x-3 mb-4">
                        <div
                            class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chart-line text-white text-lg"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">PortfolioPro</h3>
                            <p class="text-sm text-gray-600">Professional Portfolio Management</p>
                        </div>
                    </div>
                    <p class="text-gray-600 text-sm leading-relaxed">
                        A comprehensive portfolio management platform designed for professional investors.
                        Track, analyze, and optimize your investment portfolio with advanced analytics and insights.
                    </p>
                </div>

                <!-- Quick Links -->
                <div>
                    <h4 class="text-gray-900 font-semibold mb-4">Quick Links</h4>
                    <ul class="space-y-2">
                        <li><a href="index.html"
                                class="text-gray-600 hover:text-gray-900 transition-colors text-sm">Portfolio
                                Dashboard</a></li>
                        <li><a href="calculator.html"
                                class="text-gray-600 hover:text-gray-900 transition-colors text-sm">Stock Calculator</a>
                        </li>
                        <li><a href="targets.html"
                                class="text-gray-600 hover:text-gray-900 transition-colors text-sm">Target Prices</a>
                        </li>
                        <li><a href="transactions.html"
                                class="text-gray-600 hover:text-gray-900 transition-colors text-sm">Transaction
                                History</a></li>
                    </ul>
                </div>

                <!-- Support & Resources -->
                <div>
                    <h4 class="text-gray-900 font-semibold mb-4">Support & Resources</h4>
                    <ul class="space-y-2">
                        <li><a href="docs.html"
                                class="text-gray-600 hover:text-gray-900 transition-colors text-sm">Documentation</a>
                        </li>
                        <li><a href="help.html" class="text-gray-600 hover:text-gray-900 transition-colors text-sm">Help
                                Center</a></li>
                        <li><a href="tutorials.html"
                                class="text-gray-600 hover:text-gray-900 transition-colors text-sm">Tutorials</a></li>
                        <li><a href="contact.html"
                                class="text-gray-600 hover:text-gray-900 transition-colors text-sm">Contact Support</a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Bottom Section -->
            <div class="border-t border-gray-200 mt-8 pt-8">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <p class="text-gray-600 text-sm">
                        © 2024 PortfolioPro. All rights reserved.
                    </p>
                    <div class="flex space-x-6 mt-4 md:mt-0">
                        <a href="https://github.com" class="text-gray-600 hover:text-gray-900 transition-colors"
                            title="GitHub">
                            <i class="fab fa-github"></i>
                        </a>
                        <a href="mailto:support@portfoliopro.com"
                            class="text-gray-600 hover:text-gray-900 transition-colors" title="Email Support">
                            <i class="fas fa-envelope"></i>
                        </a>
                        <a href="docs.html" class="text-gray-600 hover:text-gray-900 transition-colors"
                            title="Documentation">
                            <i class="fas fa-book"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </footer>
</body>

</html>
</html>
